<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CHIMERA Hunt</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ==================== RESET & BASE ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Dark forest foundation */
            --bg-deep: #0f1f16;
            --bg: #162b1e;
            --bg-card: #1e3828;
            --bg-card-hover: #244432;
            --bg-elevated: #2a4f38;

            /* Text on dark */
            --text: #e8efe9;
            --text-muted: #8fa898;
            --text-faint: #5c7a66;
            --border: #2e5240;
            --border-light: #243d2e;

            /* XP Gold ‚Äî the reward color, stands out against green */
            --xp-gold: #e8b634;
            --xp-gold-light: #3d3216;
            --xp-gold-bg: #2a2510;
            --xp-gold-text: #f5d060;

            /* Streak fire ‚Äî warmth in the forest */
            --streak-fire: #f07938;
            --streak-warm: #3a2210;
            --streak-glow: #f59e4e;

            /* Rank ‚Äî cool silver moonlight */
            --rank-accent: #a0b8d0;
            --rank-light: #1a2a35;

            /* Calibration ‚Äî pale teal, like a forest stream */
            --calibration: #4ec9a0;
            --calibration-light: #132e24;
            --calibration-text: #6ee0b8;

            /* Status */
            --danger: #e05252;
            --success: #4eca8b;

            /* Tier colors */
            --tier-scout: #8fa898;
            --tier-hunter: #4eca8b;
            --tier-tamer: #a78bfa;
            --tier-warden: #e8b634;

            /* Header ‚Äî slightly different from bg to create depth */
            --header-bg: #0d1a12;

            --tab-height: 64px;
            --header-height: 56px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-deep);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text);
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg);
            min-height: 100vh;
            position: relative;
            padding-bottom: calc(var(--tab-height) + 16px);
        }

        /* ==================== HEADER ==================== */
        .header {
            background: var(--header-bg);
            color: var(--text);
            padding: 0 16px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
            border-bottom: 1px solid var(--border);
        }

        .header-back {
            font-size: 14px;
            color: var(--text-muted);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            padding: 6px 0;
            cursor: pointer;
            transition: color 0.2s;
        }
        .header-back:hover { color: var(--text); }
        .header-back-arrow { font-size: 18px; }

        .header-center {
            flex: 1;
            text-align: center;
        }
        .header-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header-xp {
            flex-shrink: 0;
            text-align: right;
        }
        .header-xp-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--xp-gold-text);
        }
        .header-xp-label {
            font-size: 10px;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== TAB BAR ==================== */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            height: var(--tab-height);
            background: var(--header-bg);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 100;
            box-shadow: 0 -2px 16px rgba(0,0,0,0.4);
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
            color: var(--text-faint);
            transition: color 0.2s;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        .tab.active { color: var(--xp-gold-text); }
        .tab.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--xp-gold);
            border-radius: 0 0 3px 3px;
        }
        .tab-icon { font-size: 22px; line-height: 1; }
        .tab-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }

        /* ==================== WHO-LIST BAR ==================== */
        .who-bar {
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            position: sticky;
            top: var(--header-height);
            z-index: 99;
        }
        .who-bar-collapsed {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
        }
        .who-bar-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--calibration);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .who-bar-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--calibration);
            animation: pulseDot 2s ease infinite;
        }
        @keyframes pulseDot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .who-bar-chevron {
            font-size: 14px;
            color: var(--text-faint);
            transition: transform 0.2s;
        }
        .who-bar.expanded .who-bar-chevron {
            transform: rotate(180deg);
        }

        .who-bar-list {
            display: none;
            padding: 0 16px 12px;
        }
        .who-bar.expanded .who-bar-list {
            display: block;
        }
        .who-bar-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }
        .who-bar-user-badge {
            font-size: 12px;
        }
        .who-bar-user-handle {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            flex: 1;
        }
        .who-bar-user-time {
            font-size: 11px;
            color: var(--text-faint);
        }

        .exit-realm-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: rgba(224,82,82,0.1);
            border: 1px solid rgba(224,82,82,0.3);
            border-radius: 8px;
            color: var(--danger);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .exit-realm-btn:hover {
            background: rgba(224,82,82,0.2);
        }

        /* ==================== CONTENT AREA ==================== */
        .content {
            padding: 16px;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        /* ==================== SHARED COMPONENTS ==================== */

        /* Cards */
        .game-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .game-card-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        /* Tier Badge */
        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .tier-badge.scout { background: rgba(143,168,152,0.15); color: var(--tier-scout); }
        .tier-badge.hunter { background: rgba(78,202,139,0.15); color: var(--tier-hunter); }
        .tier-badge.tamer { background: rgba(167,139,250,0.15); color: var(--tier-tamer); }
        .tier-badge.warden { background: rgba(232,182,52,0.15); color: var(--tier-warden); }
        .tier-badge-icon { font-size: 14px; }

        /* Streak Display */
        .streak-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .streak-row:last-child { border-bottom: none; }
        .streak-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .streak-value {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
        }
        .streak-fire { color: var(--streak-fire); }
        .streak-dead { color: var(--text-faint); }

        .streak-status {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .streak-status.active { background: rgba(78,202,139,0.15); color: var(--success); }
        .streak-status.endangered { background: rgba(232,182,52,0.15); color: var(--xp-gold-text); }
        .streak-status.broken { background: rgba(224,82,82,0.15); color: var(--danger); }

        /* Progress Bar */
        .progress-section { margin-top: 12px; }
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        .progress-fill.xp { background: linear-gradient(90deg, var(--bg-elevated), var(--xp-gold)); }
        .progress-fill.calibration { background: linear-gradient(90deg, var(--calibration), var(--success)); }

        /* Activity Items (game-styled) */
        .game-activity {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .game-activity:last-child { border-bottom: none; }
        .game-activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .game-activity-icon.xp { background: var(--xp-gold-light); }
        .game-activity-icon.streak { background: var(--streak-warm); }
        .game-activity-icon.validated { background: rgba(78,202,139,0.15); }
        .game-activity-icon.tier { background: rgba(167,139,250,0.15); }
        .game-activity-icon.realm { background: rgba(78,201,160,0.1); }
        .game-activity-icon.realm-exit { background: rgba(224,82,82,0.1); }
        .game-activity-icon.event { background: rgba(232,182,52,0.15); }
        .game-activity-icon.material { background: rgba(167,139,250,0.1); }
        .game-activity-icon.announcement { background: var(--bg-elevated); }
        .game-activity-body { flex: 1; }
        .game-activity-text { font-size: 13px; color: var(--text); line-height: 1.4; }
        .game-activity-meta { font-size: 11px; color: var(--text-faint); margin-top: 3px; }
        .game-activity-xp {
            font-size: 13px;
            font-weight: 700;
            color: var(--xp-gold-text);
            flex-shrink: 0;
            align-self: center;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .quick-action {
            flex: 1;
            padding: 14px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-card);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            color: var(--text);
        }
        .quick-action:hover {
            background: var(--bg-elevated);
            border-color: var(--xp-gold);
            color: var(--xp-gold-text);
        }
        .quick-action-icon { font-size: 20px; margin-bottom: 4px; }
        .quick-action-label { font-size: 12px; font-weight: 600; }

        /* ==================== LEDGER SPECIFIC ==================== */
        .ledger-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }
        .ledger-filter-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .ledger-filter-btn.active {
            background: var(--bg-elevated);
            color: var(--xp-gold-text);
            border-color: var(--xp-gold);
        }

        .ledger-entry {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
        }
        .ledger-entry:last-child { border-bottom: none; }
        .ledger-entry-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ledger-entry-source {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        .ledger-entry-xp {
            font-size: 14px;
            font-weight: 700;
            color: var(--xp-gold-text);
        }
        .ledger-entry-detail {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }
        .ledger-entry-breakdown {
            display: none;
            background: var(--bg-deep);
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.8;
        }
        .ledger-entry.expanded .ledger-entry-breakdown { display: block; }

        .ledger-total {
            background: var(--xp-gold-bg);
            border: 2px solid rgba(232,182,52,0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        .ledger-total-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--xp-gold-text);
        }
        .ledger-total-label {
            font-size: 12px;
            color: var(--xp-gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== RANKS SPECIFIC ==================== */
        .rank-filters {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .rank-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
        }
        .rank-entry:last-child { border-bottom: none; }
        .rank-entry.self {
            background: rgba(78,202,139,0.08);
            border-radius: 8px;
            border: 1px solid rgba(78,202,139,0.25);
            margin: 4px 0;
        }
        .rank-position {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-faint);
            width: 28px;
            text-align: center;
        }
        .rank-position.gold { color: var(--xp-gold-text); }
        .rank-position.silver { color: var(--rank-accent); }
        .rank-position.bronze { color: var(--streak-glow); }
        .rank-user {
            flex: 1;
        }
        .rank-handle {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        .rank-tier {
            font-size: 11px;
            color: var(--text-muted);
        }
        .rank-xp {
            font-size: 15px;
            font-weight: 700;
            color: var(--xp-gold-text);
        }

        /* ==================== TRACKER SPECIFIC ==================== */
        .tier-roadmap {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 8px;
            position: relative;
        }
        .tier-roadmap::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 12%;
            right: 12%;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }
        .tier-roadmap-progress {
            position: absolute;
            top: 50%;
            left: 12%;
            height: 3px;
            background: var(--success);
            z-index: 1;
            transition: width 0.6s ease;
        }

        .tier-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            z-index: 2;
        }
        .tier-node-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 3px solid var(--border);
            background: var(--bg-card);
            transition: all 0.3s;
        }
        .tier-node.completed .tier-node-circle {
            border-color: var(--success);
            background: rgba(78,202,139,0.2);
        }
        .tier-node.current .tier-node-circle {
            border-color: var(--xp-gold);
            background: var(--xp-gold-light);
            box-shadow: 0 0 0 4px rgba(232,182,52,0.15);
        }
        .tier-node-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-faint);
        }
        .tier-node.completed .tier-node-label { color: var(--success); }
        .tier-node.current .tier-node-label { color: var(--xp-gold-text); }

        /* Calibration Stats */
        .calibration-card {
            background: var(--calibration-light);
            border: 1px solid rgba(78,201,160,0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .calibration-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        .calibration-stat-label {
            font-size: 13px;
            color: var(--calibration);
            font-weight: 500;
        }
        .calibration-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--calibration-text);
        }

        /* Triangle Status */
        .triangle-status {
            background: rgba(78,202,139,0.06);
            border: 2px dashed rgba(78,202,139,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .triangle-status-icon { font-size: 32px; margin-bottom: 8px; }
        .triangle-status-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 4px;
        }
        .triangle-status-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .triangle-btn {
            margin-top: 14px;
            padding: 12px 24px;
            background: var(--success);
            color: var(--bg-deep);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .triangle-btn:hover { background: #5ee0a0; }

        /* ==================== TERRITORY MAP ==================== */
        .territory-map-container {
            display: none;
        }
        .territory-map-container.active {
            display: block;
        }

        #territoryMap {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            border: 2px solid var(--bg-elevated);
            z-index: 1;
        }

        .map-selection-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 10px;
        }

        .map-selection-count {
            font-size: 13px;
            color: var(--text-muted);
        }
        .map-selection-count strong {
            color: var(--success);
        }

        .map-validate-btn {
            padding: 10px 20px;
            background: var(--success);
            color: var(--bg-deep);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0.4;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .map-validate-btn.ready {
            opacity: 1;
            pointer-events: auto;
        }
        .map-validate-btn.ready:hover { background: #5ee0a0; }

        .map-back-btn {
            padding: 8px 16px;
            background: var(--bg-elevated);
            color: var(--text-muted);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .map-result {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }
        .map-result.success {
            background: rgba(78,202,139,0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        .map-result.fail {
            background: rgba(239,68,68,0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .map-side-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--bg-deep);
            background: var(--success);
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .map-side-label.fail {
            background: #ef4444;
            color: #fff;
        }

        .map-legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .map-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ==================== PROFILE MODAL ==================== */
        .profile-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .profile-overlay.active {
            display: flex;
        }
        .profile-card {
            background: var(--bg-card);
            border-radius: 14px;
            width: 100%;
            max-width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px 20px;
            position: relative;
        }
        .profile-close {
            position: absolute;
            top: 12px; right: 14px;
            background: none; border: none;
            color: var(--text-faint);
            font-size: 20px;
            cursor: pointer;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 16px;
        }
        .profile-tier-icon {
            font-size: 36px;
            margin-bottom: 6px;
        }
        .profile-handle {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        .profile-title-display {
            font-size: 13px;
            color: var(--calibration-text);
            font-style: italic;
            margin-top: 2px;
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin-bottom: 14px;
        }
        .profile-stat {
            text-align: center;
        }
        .profile-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        .profile-stat-label {
            font-size: 11px;
            color: var(--text-faint);
            margin-top: 2px;
        }
        .profile-bio-section {
            margin-bottom: 14px;
        }
        .profile-bio-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .profile-bio-text {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .profile-bio-empty {
            font-size: 13px;
            color: var(--text-faint);
            font-style: italic;
        }
        .profile-edit-field {
            width: 100%;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            padding: 8px 10px;
            font-family: inherit;
            resize: vertical;
        }
        .profile-edit-field:focus {
            outline: none;
            border-color: var(--success);
        }
        .profile-edit-hint {
            font-size: 10px;
            color: var(--text-faint);
            margin-top: 3px;
            text-align: right;
        }
        .profile-save-btn {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: var(--bg-deep);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .profile-save-btn:hover { background: #5ee0a0; }
        .profile-enrolled {
            font-size: 11px;
            color: var(--text-faint);
            text-align: center;
            margin-top: 10px;
        }

        /* ==================== TOAST ==================== */
        .toast-container {
            position: fixed;
            top: 70px;
            right: -350px;
            width: 320px;
            z-index: 1000;
            transition: right 0.3s ease;
        }
        .toast-container.show { right: 16px; }
        .toast {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 14px 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--success);
        }
        .toast-icon { font-size: 20px; }
        .toast-message { flex: 1; font-size: 14px; color: var(--text); font-weight: 500; }

        /* ==================== EMPTY STATES ==================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-faint);
        }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; line-height: 1.5; }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .screen.active { animation: fadeIn 0.25s ease; }

        @keyframes pulseGold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212, 160, 23, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(212, 160, 23, 0); }
        }
        .tier-node.current .tier-node-circle { animation: pulseGold 2.5s ease infinite; }

        /* ==================== UTILITY ==================== */
        .hidden { display: none !important; }
        .text-gold { color: var(--xp-gold-text); }
        .text-muted { color: var(--text-muted); }
        .text-sm { font-size: 12px; }
        .mt-12 { margin-top: 12px; }
        .mb-12 { margin-bottom: 12px; }
    </style>
</head>
<body>
    <!-- ==================== TOAST ==================== -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <!-- ==================== HEADER ==================== -->
        <div class="header">
            <a class="header-back" id="backToChimera">
                <span class="header-back-arrow">‚Äπ</span>
                <span>CHIMERA</span>
            </a>
            <div class="header-center">
                <div class="header-title">CHIMERA Hunt</div>
            </div>
            <div class="header-xp">
                <div class="header-xp-value" id="headerXP">0</div>
                <div class="header-xp-label">Total XP</div>
            </div>
        </div>

        <!-- ==================== WHO-LIST BAR ==================== -->
        <div class="who-bar" id="whoBar">
            <div class="who-bar-collapsed" id="whoBarToggle">
                <div class="who-bar-count">
                    <div class="who-bar-dot"></div>
                    <span id="whoBarCount">0 in the realm</span>
                </div>
                <span class="who-bar-chevron">‚ñº</span>
            </div>
            <div class="who-bar-list" id="whoBarList">
                <!-- Populated by JS -->
                <button class="exit-realm-btn" id="exitRealmBtn">Exit Realm</button>
            </div>
        </div>

        <!-- ==================== SCREEN: HALL ==================== -->
        <div class="content">
            <div class="screen active" id="screenHall">
                <!-- Tier & XP Summary -->
                <div class="game-card">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span class="tier-badge scout" id="hallTierBadge">
                            <span class="tier-badge-icon">üîç</span>
                            <span>Scout</span>
                        </span>
                        <span style="font-size: 12px; color: var(--text-muted);" id="hallNextTier">Next: Hunter</span>
                    </div>

                    <div class="progress-section">
                        <div class="progress-label">
                            <span id="hallProgressText">0 / 250 XP</span>
                            <span id="hallProgressPct">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill xp" id="hallProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Streaks -->
                <div class="game-card">
                    <div class="game-card-header">Active Streaks</div>
                    <div class="streak-row">
                        <span class="streak-label">Scout (Daily)</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="streak-value streak-fire" id="hallScoutStreak">üî• 0</span>
                            <span class="streak-status active" id="hallScoutStatus">Active</span>
                        </div>
                    </div>
                    <div class="streak-row">
                        <span class="streak-label">Hunter (Weekly)</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="streak-value streak-dead" id="hallHunterStreak">‚Äî 0</span>
                            <span class="streak-status broken" id="hallHunterStatus">Locked</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="quick-action" id="actionScout">
                        <div class="quick-action-icon">üîç</div>
                        <div class="quick-action-label">Rate Location</div>
                    </div>
                    <div class="quick-action" id="actionCollect">
                        <div class="quick-action-icon">üóëÔ∏è</div>
                        <div class="quick-action-label">Go Collect</div>
                    </div>
                </div>

                <!-- Global Hall Feed -->
                <div class="game-card">
                    <div class="game-card-header">The Hunt</div>
                    <div id="hallActivityList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üå≤</div>
                            <div class="empty-state-text">The realm is quiet...<br>Be the first to enter.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SCREEN: LEDGER ==================== -->
            <div class="screen" id="screenLedger">
                <!-- Total -->
                <div class="ledger-total">
                    <div class="ledger-total-value" id="ledgerTotal">0 XP</div>
                    <div class="ledger-total-label">Total Earned</div>
                </div>

                <!-- Time Filters -->
                <div class="ledger-filter">
                    <button class="ledger-filter-btn active" data-filter="today">Today</button>
                    <button class="ledger-filter-btn" data-filter="week">This Week</button>
                    <button class="ledger-filter-btn" data-filter="all">All Time</button>
                </div>

                <!-- XP Entries -->
                <div class="game-card" style="padding: 0;">
                    <div id="ledgerEntries">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìí</div>
                            <div class="empty-state-text">No XP entries yet.<br>Start building your record!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SCREEN: RANKS ==================== -->
            <div class="screen" id="screenRanks">
                <!-- Time Toggle -->
                <div class="rank-filters">
                    <button class="ledger-filter-btn active" data-rank="alltime">All-Time</button>
                    <button class="ledger-filter-btn" data-rank="weekly">Weekly</button>
                    <button class="ledger-filter-btn" data-rank="monthly">Monthly</button>
                </div>

                <!-- Scope Toggle -->
                <div class="rank-filters" style="margin-bottom: 16px;">
                    <button class="ledger-filter-btn active" data-scope="everyone">Everyone</button>
                    <button class="ledger-filter-btn" data-scope="org">My Org</button>
                    <button class="ledger-filter-btn" data-scope="zone">My Zone</button>
                </div>

                <!-- Leaderboard -->
                <div class="game-card" style="padding: 0;">
                    <div id="ranksList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üèÜ</div>
                            <div class="empty-state-text">Leaderboard loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SCREEN: TRACKER ==================== -->
            <div class="screen" id="screenTracker">
                <!-- Tier Roadmap -->
                <div class="game-card">
                    <div class="game-card-header">Progression</div>
                    <div class="tier-roadmap">
                        <div class="tier-roadmap-progress" id="roadmapProgress" style="width: 0%;"></div>
                        <div class="tier-node current" id="nodeScout">
                            <div class="tier-node-circle">üîç</div>
                            <div class="tier-node-label">Scout</div>
                        </div>
                        <div class="tier-node" id="nodeHunter">
                            <div class="tier-node-circle">üó°Ô∏è</div>
                            <div class="tier-node-label">Hunter</div>
                        </div>
                        <div class="tier-node" id="nodeTamer">
                            <div class="tier-node-circle">üêâ</div>
                            <div class="tier-node-label">Tamer</div>
                        </div>
                        <div class="tier-node" id="nodeWarden">
                            <div class="tier-node-circle">üõ°Ô∏è</div>
                            <div class="tier-node-label">Warden</div>
                        </div>
                    </div>
                </div>

                <!-- Scout: Triangle Status (Hunter unlock gate) -->
                <div id="trackerScoutSection">
                    <!-- Intro view -->
                    <div class="triangle-status" id="triangleIntro">
                        <div class="triangle-status-icon">üìê</div>
                        <div class="triangle-status-title">Prove Your Territory</div>
                        <div class="triangle-status-desc">
                            Select 3 scouted locations that form a triangle (0.5‚Äì1.0 mi sides) to unlock Hunter class.
                        </div>
                        <button class="triangle-btn" id="startTriangleBtn">Map My Territory</button>
                    </div>

                    <!-- Map view (hidden until button tap) -->
                    <div class="territory-map-container" id="territoryMapContainer">
                        <div id="territoryMap"></div>

                        <div class="map-legend">
                            <div class="map-legend-item"><div class="map-legend-dot" style="background: #4eca8b;"></div> Available</div>
                            <div class="map-legend-item"><div class="map-legend-dot" style="background: #e8b634;"></div> Selected</div>
                        </div>

                        <div class="map-selection-bar">
                            <div>
                                <div class="map-selection-count"><strong id="mapSelCount">0</strong> / 3 selected</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="map-back-btn" id="mapBackBtn">‚Üê Back</button>
                                <button class="map-validate-btn" id="mapValidateBtn">Validate Triangle</button>
                            </div>
                        </div>

                        <div class="map-result" id="mapResult" style="display: none;"></div>
                    </div>
                </div>

                <!-- Hunter: Quest Guidance -->
                <div id="trackerHunterSection" class="hidden">
                    <div class="game-card" style="border-left: 3px solid var(--tier-hunter);">
                        <div class="game-card-header" style="color: var(--tier-hunter);">üó°Ô∏è Hunter's Path</div>
                        <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">
                            <p style="margin-bottom: 10px;">You've proven your territory. Now it's time to collect.</p>
                            <p style="margin-bottom: 10px;"><strong style="color: var(--text);">Your mission:</strong> Go to locations you've scouted, collect litter, and see how your ratings compare to what's actually out there. The closer your ratings match reality, the higher your calibration multiplier ‚Äî and the more XP everything earns.</p>
                            <p style="margin-bottom: 6px;"><strong style="color: var(--text);">Keep building:</strong></p>
                            <span style="color: var(--text);">‚Ä¢ Scout daily</span> to maintain your streak<br>
                            <span style="color: var(--text);">‚Ä¢ Collect weekly</span> to build your hunter streak<br>
                            <span style="color: var(--text);">‚Ä¢ Watch your calibration</span> stats below as data comes in
                        </div>
                    </div>
                </div>

                <!-- Calibration Stats (hidden until data exists) -->
                <div class="calibration-card mt-12" id="trackerCalibrationSection">
                    <div class="game-card-header" style="color: var(--calibration);">Calibration</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                        Your rating accuracy shapes your XP multiplier. Collect near scouted locations to generate calibration data.
                    </div>
                    <div class="calibration-stat">
                        <span class="calibration-stat-label">Avg Divergence</span>
                        <span class="calibration-stat-value" id="calDivergence">‚Äî</span>
                    </div>
                    <div class="calibration-stat">
                        <span class="calibration-stat-label">Bias Trend</span>
                        <span class="calibration-stat-value" id="calBias">‚Äî</span>
                    </div>
                    <div class="calibration-stat">
                        <span class="calibration-stat-label">Current Multiplier</span>
                        <span class="calibration-stat-value" id="calMultiplier">1.00√ó</span>
                    </div>
                    <div class="progress-section">
                        <div class="progress-label">
                            <span>Accuracy</span>
                            <span id="calAccuracyPct">‚Äî</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill calibration" id="calProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Material Training (Tamer section, hidden until Hunter) -->
                <div id="trackerTamerSection" class="hidden">
                    <div class="game-card">
                        <div class="game-card-header">Material Training</div>
                        <div class="empty-state">
                            <div class="empty-state-icon">üß™</div>
                            <div class="empty-state-text">Complete Hunter collections to<br>unlock material training quests.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB BAR ==================== -->
        <div class="tab-bar">
            <div class="tab active" data-tab="screenHall">
                <span class="tab-icon">üè†</span>
                <span class="tab-label">Hall</span>
            </div>
            <div class="tab" data-tab="screenLedger">
                <span class="tab-icon">üìí</span>
                <span class="tab-label">Ledger</span>
            </div>
            <div class="tab" data-tab="screenRanks">
                <span class="tab-icon">üèÜ</span>
                <span class="tab-label">Ranks</span>
            </div>
            <div class="tab" data-tab="screenTracker">
                <span class="tab-icon">üìà</span>
                <span class="tab-label">Tracker</span>
            </div>
        </div>
    </div>

    <!-- ==================== PROFILE MODAL ==================== -->
    <div class="profile-overlay" id="profileOverlay">
        <div class="profile-card" id="profileCard">
            <button class="profile-close" id="profileClose">&times;</button>
            <div class="profile-header">
                <div class="profile-tier-icon" id="profileTierIcon">üîç</div>
                <div class="profile-handle" id="profileHandle">‚Äî</div>
                <div class="profile-title-display" id="profileTitleDisplay"></div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileTier">Scout</div>
                    <div class="profile-stat-label">Tier</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileLevel">1</div>
                    <div class="profile-stat-label">Level</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileXP">0</div>
                    <div class="profile-stat-label">XP</div>
                </div>
            </div>
            <!-- View mode -->
            <div id="profileViewMode">
                <div class="profile-bio-section">
                    <div class="profile-bio-label">Title</div>
                    <div class="profile-bio-text" id="profileTitleView"></div>
                </div>
                <div class="profile-bio-section">
                    <div class="profile-bio-label">Bio</div>
                    <div class="profile-bio-text" id="profileBioView"></div>
                </div>
            </div>
            <!-- Edit mode (own profile only) -->
            <div id="profileEditMode" style="display: none;">
                <div class="profile-bio-section">
                    <div class="profile-bio-label">Title</div>
                    <input type="text" class="profile-edit-field" id="profileTitleInput" placeholder="e.g. Iarwain the First of His Name" maxlength="60">
                    <div class="profile-edit-hint"><span id="profileTitleCount">0</span>/60</div>
                </div>
                <div class="profile-bio-section">
                    <div class="profile-bio-label">Bio</div>
                    <textarea class="profile-edit-field" id="profileBioInput" placeholder="Write your character's story..." rows="4" maxlength="500"></textarea>
                    <div class="profile-edit-hint"><span id="profileBioCount">0</span>/500</div>
                </div>
                <button class="profile-save-btn" id="profileSaveBtn">Save Profile</button>
            </div>
            <div class="profile-enrolled" id="profileEnrolled"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const HUNT_VERSION = 'V0.6.3-260212';
        console.log('üéÆ CHIMERA Hunt Version:', HUNT_VERSION);

        const CONFIG = {
            chimeraScriptUrl: 'https://script.google.com/macros/s/AKfycbysweOefC4Y8Ed4w_6OZzfDZ-vEoqZLqKRCboH9AivIZ_-jSbwkj70VXTRPP0jZJme0NA/exec',
            huntScriptUrl: 'https://script.google.com/macros/s/AKfycbx06yKEEClVKfEb0z14ZCYaZs8VE2xdFtqcLRV9i9NJRo204uQur_tEWKeAYeEsuGpE/exec',
            chimeraUrl: 'index.html'
        };

        // ==========================================
        // GAME STATE
        // ==========================================
        let gameState = {
            userId: null,
            handle: null,
            tier: 'scout', // scout | hunter | tamer | warden
            totalXP: 0,
            level: { level: 0, xpIntoLevel: 0, xpForNextLevel: 100 },
            scoutStreak: { count: 0, status: 'active' },
            hunterStreak: { count: 0, status: 'locked' },
            calibration: { divergence: null, bias: null, multiplier: 1.0 },
            triangleComplete: false
        };

        let whoList = [];
        let hallFeed = [];
        let heartbeatInterval = null;

        // ==========================================
        // AUTH - Read from CHIMERA's session
        // ==========================================
        function loadAuth() {
            const saved = sessionStorage.getItem('chimera_user');
            if (saved) {
                try {
                    const user = JSON.parse(saved);
                    gameState.userId = user.userId;
                    gameState.handle = user.handle;
                    return true;
                } catch (e) { return false; }
            }
            return false;
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        const tabs = document.querySelectorAll('.tab');
        const screens = document.querySelectorAll('.screen');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                screens.forEach(s => s.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');

                // Fire API calls on tab switch
                if (targetId === 'screenLedger' && gameState.userId && CONFIG.huntScriptUrl) {
                    const activeFilter = document.querySelector('.ledger-filter-btn[data-filter].active');
                    loadLedger(activeFilter ? activeFilter.dataset.filter : 'all');
                }
                if (targetId === 'screenRanks' && gameState.userId && CONFIG.huntScriptUrl) {
                    const activeRank = document.querySelector('.ledger-filter-btn[data-rank].active');
                    const activeScope = document.querySelector('.ledger-filter-btn[data-scope].active');
                    loadLeaderboard(
                        activeRank ? activeRank.dataset.rank : 'alltime',
                        activeScope ? activeScope.dataset.scope : 'everyone'
                    );
                }
            });
        });

        // ==========================================
        // LEDGER FILTERS
        // ==========================================
        document.querySelectorAll('.ledger-filter-btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ledger-filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (gameState.userId && CONFIG.huntScriptUrl) {
                    loadLedger(btn.dataset.filter);
                }
            });
        });

        // Ledger entry expand/collapse
        document.getElementById('ledgerEntries').addEventListener('click', (e) => {
            const entry = e.target.closest('.ledger-entry');
            if (entry) entry.classList.toggle('expanded');
        });

        // ==========================================
        // RANK FILTERS
        // ==========================================
        document.querySelectorAll('.ledger-filter-btn[data-rank]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ledger-filter-btn[data-rank]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const activeScope = document.querySelector('.ledger-filter-btn[data-scope].active');
                if (gameState.userId && CONFIG.huntScriptUrl) {
                    loadLeaderboard(btn.dataset.rank, activeScope ? activeScope.dataset.scope : 'everyone');
                }
            });
        });

        document.querySelectorAll('.ledger-filter-btn[data-scope]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ledger-filter-btn[data-scope]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const activeRank = document.querySelector('.ledger-filter-btn[data-rank].active');
                if (gameState.userId && CONFIG.huntScriptUrl) {
                    loadLeaderboard(activeRank ? activeRank.dataset.rank : 'alltime', btn.dataset.scope);
                }
            });
        });

        // ==========================================
        // QUICK ACTIONS - Link back to CHIMERA with handshake
        // ==========================================
        document.getElementById('actionScout').addEventListener('click', () => {
            window.location.href = CONFIG.chimeraUrl + '?from=hunt&action=scout';
        });

        document.getElementById('actionCollect').addEventListener('click', () => {
            window.location.href = CONFIG.chimeraUrl + '?from=hunt&action=collect';
        });

        // ==========================================
        // BACK TO CHIMERA (triggers exit realm)
        // ==========================================
        document.getElementById('backToChimera').addEventListener('click', () => {
            exitRealm();
        });

        // ==========================================
        // TOAST
        // ==========================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? '‚úì' : '‚ö†';
            toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-message">${message}</div>`;
            container.appendChild(toast);
            container.classList.add('show');
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                    if (container.children.length === 0) container.classList.remove('show');
                }, 300);
            }, 3000);
        }

        // ==========================================
        // API CALLS
        // ==========================================
        async function huntPost(action, data = {}) {
            try {
                const response = await fetch(CONFIG.huntScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...data })
                });
                return await response.json();
            } catch (err) {
                console.error('Hunt API error:', err);
                return { status: 'error', message: err.toString() };
            }
        }

        async function huntGet(action, params = {}) {
            const url = new URL(CONFIG.huntScriptUrl);
            url.searchParams.set('action', action);
            for (const [k, v] of Object.entries(params)) {
                url.searchParams.set(k, v);
            }
            try {
                const response = await fetch(url.toString());
                return await response.json();
            } catch (err) {
                console.error('Hunt API error:', err);
                return { status: 'error', message: err.toString() };
            }
        }

        async function fireEnterTheHunt() {
            console.log('üè∞ Entering the Hunt...');
            const result = await huntPost('enterTheHunt', { userId: gameState.userId });

            if (result.status === 'error') {
                console.error('enterTheHunt failed:', result.message);
                showToast('Connection error ‚Äî loading demo data', 'warning');
                loadDemoData();
                renderHall();
                renderWhoList();
                renderHallFeed();
                renderTracker();
                return;
            }

            if (!result.enrolled) {
                console.log('üÜï User not enrolled ‚Äî show onboarding');
                // TODO: Show onboarding screen
                // For now, offer to enroll
                showOnboarding();
                return;
            }

            // Apply live game state
            const gs = result.gameState;
            gameState.tier = gs.tier;
            gameState.totalXP = gs.totalXP;
            gameState.level = gs.level || { level: 0, xpIntoLevel: 0, xpForNextLevel: 100 };
            gameState.scoutStreak = gs.scoutStreak;
            gameState.hunterStreak = gs.hunterStreak;
            gameState.calibration = {
                divergence: gs.calibration.avgDivergence,
                bias: gs.calibration.biasTrend,
                multiplier: gs.calibration.multiplier
            };
            gameState.triangleComplete = gs.triangleComplete;
            gameState.profile = gs.profile || { characterTitle: '', characterBio: '' };

            // Apply live Hall feed
            hallFeed = (result.hallFeed || []).map(e => ({
                icon: e.icon || 'realm',
                emoji: feedEmoji(e.icon || e.type),
                text: e.text,
                timestamp: e.timestamp
            }));

            // Apply live who-list
            whoList = (result.whoList || []).map(u => ({
                userId: u.userId,
                handle: u.handle,
                tier: u.tier,
                enteredAt: u.enteredAt,
                lastHeartbeat: u.lastHeartbeat
            }));

            // Show new XP awards
            if (result.newXPAwarded && result.newXPAwarded.length > 0) {
                const totalNew = result.newXPAwarded.reduce((sum, x) => sum + x.finalXP, 0);
                showToast(`+${totalNew} XP earned!`);
            }

            renderHall();
            renderWhoList();
            renderHallFeed();
            renderTracker();
            console.log('‚úÖ Hunt loaded. Tier:', gs.tier, 'XP:', gs.totalXP);
        }

        async function fireEnrollUser() {
            const result = await huntPost('enrollUser', { userId: gameState.userId });
            if (result.status === 'success' && result.enrolled) {
                showToast('Welcome to the Hunt.');
                // Now enter normally
                fireEnterTheHunt();
            } else {
                showToast('Enrollment failed: ' + (result.message || 'Unknown error'), 'warning');
            }
        }

        function showOnboarding() {
            // Simple onboarding prompt ‚Äî will be replaced with full UI later
            const hallList = document.getElementById('hallActivityList');
            hallList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üå≤</div>
                    <div class="empty-state-text">
                        Welcome, traveler.<br><br>
                        The Hunt transforms cleanup data collection into an adventure.
                        Scout locations, build streaks, earn XP, and prove your territory.<br><br>
                    </div>
                    <button class="triangle-btn" id="enrollConfirmBtn" style="margin-top: 12px;">Enter the Hunt</button>
                </div>
            `;
            document.getElementById('enrollConfirmBtn').addEventListener('click', () => {
                fireEnrollUser();
            });
        }

        function feedEmoji(iconType) {
            const map = {
                'realm': 'üåø',
                'realm_enter': 'üåø',
                'realm-exit': 'üö™',
                'realm_exit': 'üö™',
                'streak': 'üî•',
                'streak_milestone': 'üî•',
                'validated': '‚úì',
                'first_validated': '‚úì',
                'tier': '‚öîÔ∏è',
                'tier_unlock': '‚öîÔ∏è',
                'event': 'üìØ',
                'event_start': 'üìØ',
                'event_end': 'üèÅ',
                'material': 'üß™',
                'material_trained': 'üß™',
                'announcement': 'üì¢',
                'admin_announcement': 'üì¢',
                'level': '‚¨ÜÔ∏è',
                'level_up': '‚¨ÜÔ∏è'
            };
            return map[iconType] || 'üåø';
        }

        // ==========================================
        // LEDGER: Load from API
        // ==========================================
        async function loadLedger(filter) {
            console.log('üìí Loading ledger:', filter);
            document.getElementById('ledgerEntries').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìí</div>
                    <div class="empty-state-text">Loading...</div>
                </div>
            `;

            const result = await huntGet('getXPLedger', { userId: gameState.userId, filter: filter });

            if (result.status !== 'success') {
                document.getElementById('ledgerEntries').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Could not load ledger</div>
                    </div>
                `;
                return;
            }

            document.getElementById('ledgerTotal').textContent = (result.totalXP || 0).toLocaleString() + ' XP';

            if (!result.entries || result.entries.length === 0) {
                document.getElementById('ledgerEntries').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìí</div>
                        <div class="empty-state-text">No XP entries for this period.</div>
                    </div>
                `;
                return;
            }

            document.getElementById('ledgerEntries').innerHTML = result.entries.map(e => {
                const details = e.details || {};
                let breakdownHTML = '';

                if (e.source === 'scout_streak') {
                    breakdownHTML = `
                        Base XP: ${details.base || '‚Äî'}<br>
                        Escalation: +${details.escalation || 0}<br>
                        Calibration √ó${(details.calibrationMultiplier || 1).toFixed(2)}: ${e.finalXP} XP
                    `;
                } else if (e.source === 'hunter_streak') {
                    breakdownHTML = `
                        Base XP: ${details.base || '‚Äî'}<br>
                        Escalation: +${details.escalation || 0}<br>
                        Calibration √ó${(details.calibrationMultiplier || 1).toFixed(2)}: ${e.finalXP} XP
                    `;
                } else if (e.source === 'scout_validated') {
                    breakdownHTML = `
                        Scout rating: ${details.scoutRating || '‚Äî'}<br>
                        ‚àöCPUE: ${details.sqrtCpue || '‚Äî'}<br>
                        Divergence: ${details.divergence !== undefined ? details.divergence.toFixed(1) : '‚Äî'}<br>
                        Accuracy band: ${details.accuracyBand || '‚Äî'}<br>
                        Calibration √ó${(details.calibrationMultiplier || 1).toFixed(2)}: ${e.finalXP} XP
                    `;
                } else if (e.source === 'multi_collection') {
                    breakdownHTML = `Collection #${details.collectionNumber || '‚Äî'} this week`;
                } else if (e.source === 'tier_unlock') {
                    breakdownHTML = `Territory proven! Triangle validated.`;
                } else {
                    breakdownHTML = JSON.stringify(details);
                }

                const sourceLabels = {
                    'scout_streak': 'üî• Scout Streak',
                    'hunter_streak': 'üó°Ô∏è Hunter Streak',
                    'scout_validated': '‚úì Scout Validated',
                    'multi_collection': 'üì¶ Multi-Collection',
                    'tier_unlock': '‚öîÔ∏è Tier Unlock',
                    'event_bonus': 'üìØ Event Bonus'
                };

                return `
                    <div class="ledger-entry">
                        <div class="ledger-entry-top">
                            <span class="ledger-entry-source">${sourceLabels[e.source] || e.source}</span>
                            <span class="ledger-entry-xp">+${e.finalXP} XP</span>
                        </div>
                        <div class="ledger-entry-detail">${e.description}</div>
                        <div class="ledger-entry-breakdown">${breakdownHTML}</div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // LEADERBOARD: Load from API
        // ==========================================
        async function loadLeaderboard(period, scope) {
            console.log('üèÜ Loading leaderboard:', period, scope);
            document.getElementById('ranksList').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üèÜ</div>
                    <div class="empty-state-text">Loading...</div>
                </div>
            `;

            const result = await huntGet('getLeaderboard', {
                userId: gameState.userId,
                period: period,
                scope: scope
            });

            if (result.status !== 'success') {
                document.getElementById('ranksList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Could not load leaderboard</div>
                    </div>
                `;
                return;
            }

            if (!result.rankings || result.rankings.length === 0) {
                document.getElementById('ranksList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÜ</div>
                        <div class="empty-state-text">No rankings yet.<br>Be the first!</div>
                    </div>
                `;
                return;
            }

            const tierIcons = { scout: 'üîç', hunter: 'üó°Ô∏è', tamer: 'üêâ', warden: 'üõ°Ô∏è' };

            document.getElementById('ranksList').innerHTML = result.rankings.map(r => {
                const posClass = r.rank === 1 ? 'gold' : r.rank === 2 ? 'silver' : r.rank === 3 ? 'bronze' : '';
                const selfClass = r.isSelf ? ' self' : '';

                return `
                    <div class="rank-entry${selfClass}">
                        <span class="rank-position ${posClass}">${r.rank}</span>
                        <div class="rank-user">
                            <div class="rank-handle">${r.handle}</div>
                            <div class="rank-tier">${tierIcons[r.tier] || 'üîç'} ${(r.tier || 'scout').charAt(0).toUpperCase() + (r.tier || 'scout').slice(1)}</div>
                        </div>
                        <span class="rank-xp">${r.xp.toLocaleString()} XP</span>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // WHO-LIST BAR
        // ==========================================
        document.getElementById('whoBarToggle').addEventListener('click', () => {
            document.getElementById('whoBar').classList.toggle('expanded');
        });

        function renderWhoList() {
            const count = whoList.length;
            document.getElementById('whoBarCount').textContent = 
                count === 0 ? 'The realm is empty' :
                count === 1 ? '1 in the realm' :
                `${count} in the realm`;

            const listEl = document.getElementById('whoBarList');
            const exitBtn = document.getElementById('exitRealmBtn');
            
            // Clear existing users (keep exit button)
            const existingUsers = listEl.querySelectorAll('.who-bar-user');
            existingUsers.forEach(u => u.remove());

            const tierIcons = { scout: 'üîç', hunter: 'üó°Ô∏è', tamer: 'üêâ', warden: 'üõ°Ô∏è' };

            whoList.forEach(user => {
                const el = document.createElement('div');
                el.className = 'who-bar-user';
                const ago = getTimeAgo(user.enteredAt);
                const isMe = user.userId === gameState.userId;
                el.innerHTML = `
                    <span class="who-bar-user-badge">${tierIcons[user.tier] || 'üîç'}</span>
                    <span class="who-bar-user-handle" data-userid="${user.userId}" style="cursor:pointer;">${user.handle}${isMe ? ' (you)' : ''}</span>
                    <span class="who-bar-user-time">${ago}</span>
                `;
                // Tap to open profile
                el.querySelector('.who-bar-user-handle').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openProfile(user.userId);
                });
                listEl.insertBefore(el, exitBtn);
            });
        }

        // ==========================================
        // EXIT REALM
        // ==========================================
        document.getElementById('exitRealmBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            exitRealm();
        });

        function exitRealm() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            console.log('üö™ Exiting realm...');
            if (gameState.userId && CONFIG.huntScriptUrl) {
                // Fire and forget ‚Äî don't wait for response before navigating
                huntPost('exitTheHunt', { userId: gameState.userId });
            }
            window.location.href = CONFIG.chimeraUrl + '?from=hunt';
        }

        // ==========================================
        // PROFILE MODAL
        // ==========================================
        const profileOverlay = document.getElementById('profileOverlay');
        const profileClose = document.getElementById('profileClose');
        const profileSaveBtn = document.getElementById('profileSaveBtn');
        const profileTitleInput = document.getElementById('profileTitleInput');
        const profileBioInput = document.getElementById('profileBioInput');

        // Close modal
        profileClose.addEventListener('click', () => closeProfile());
        profileOverlay.addEventListener('click', (e) => {
            if (e.target === profileOverlay) closeProfile();
        });

        function closeProfile() {
            profileOverlay.classList.remove('active');
        }

        // Character counters
        profileTitleInput.addEventListener('input', () => {
            document.getElementById('profileTitleCount').textContent = profileTitleInput.value.length;
        });
        profileBioInput.addEventListener('input', () => {
            document.getElementById('profileBioCount').textContent = profileBioInput.value.length;
        });

        async function openProfile(userId) {
            const tierIcons = { scout: 'üîç', hunter: 'üó°Ô∏è', tamer: 'üêâ', warden: 'üõ°Ô∏è' };
            const tierNames = { scout: 'Scout', hunter: 'Hunter', tamer: 'Tamer', warden: 'Warden' };
            const isMe = userId === gameState.userId;

            // Show modal immediately with loading state
            document.getElementById('profileHandle').textContent = 'Loading...';
            document.getElementById('profileTitleDisplay').textContent = '';
            document.getElementById('profileTierIcon').textContent = '‚è≥';
            document.getElementById('profileTier').textContent = '‚Äî';
            document.getElementById('profileLevel').textContent = '‚Äî';
            document.getElementById('profileXP').textContent = '‚Äî';
            document.getElementById('profileViewMode').style.display = 'none';
            document.getElementById('profileEditMode').style.display = 'none';
            document.getElementById('profileEnrolled').textContent = '';
            profileOverlay.classList.add('active');

            try {
                const result = await huntGet('getProfile', { userId: userId });
                if (result.status !== 'success') {
                    document.getElementById('profileHandle').textContent = 'Error loading profile';
                    return;
                }

                const p = result.profile;
                const tier = p.tier || 'scout';

                // Header
                document.getElementById('profileTierIcon').textContent = tierIcons[tier] || 'üîç';
                document.getElementById('profileHandle').textContent = p.handle || userId;
                document.getElementById('profileTitleDisplay').textContent = p.characterTitle || '';

                // Stats
                document.getElementById('profileTier').textContent = tierNames[tier] || 'Scout';
                document.getElementById('profileLevel').textContent = p.level ? p.level.level : '1';
                document.getElementById('profileXP').textContent = (p.totalXP || 0).toLocaleString();

                // Enrolled date
                if (p.enrolledAt) {
                    const d = new Date(p.enrolledAt);
                    document.getElementById('profileEnrolled').textContent = 'Joined ' + d.toLocaleDateString();
                }

                if (isMe) {
                    // Edit mode
                    document.getElementById('profileViewMode').style.display = 'none';
                    document.getElementById('profileEditMode').style.display = 'block';
                    profileTitleInput.value = p.characterTitle || '';
                    profileBioInput.value = p.characterBio || '';
                    document.getElementById('profileTitleCount').textContent = profileTitleInput.value.length;
                    document.getElementById('profileBioCount').textContent = profileBioInput.value.length;
                } else {
                    // View mode
                    document.getElementById('profileEditMode').style.display = 'none';
                    document.getElementById('profileViewMode').style.display = 'block';
                    const titleView = document.getElementById('profileTitleView');
                    const bioView = document.getElementById('profileBioView');
                    titleView.textContent = p.characterTitle || '';
                    titleView.className = p.characterTitle ? 'profile-bio-text' : 'profile-bio-empty';
                    if (!p.characterTitle) titleView.textContent = 'No title set';
                    bioView.textContent = p.characterBio || '';
                    bioView.className = p.characterBio ? 'profile-bio-text' : 'profile-bio-empty';
                    if (!p.characterBio) bioView.textContent = 'No bio written yet';
                }
            } catch (err) {
                console.error('Profile load error:', err);
                document.getElementById('profileHandle').textContent = 'Failed to load';
            }
        }

        // Save profile
        profileSaveBtn.addEventListener('click', async () => {
            profileSaveBtn.textContent = 'Saving...';
            profileSaveBtn.disabled = true;
            try {
                const result = await huntPost('updateProfile', {
                    userId: gameState.userId,
                    characterTitle: profileTitleInput.value.trim(),
                    characterBio: profileBioInput.value.trim()
                });
                if (result.status === 'success') {
                    // Update local gameState
                    gameState.profile = {
                        characterTitle: profileTitleInput.value.trim(),
                        characterBio: profileBioInput.value.trim()
                    };
                    // Update display title in modal
                    document.getElementById('profileTitleDisplay').textContent = profileTitleInput.value.trim();
                    showToast('Profile saved!');
                    closeProfile();
                } else {
                    showToast('Save failed: ' + (result.message || 'unknown error'));
                }
            } catch (err) {
                console.error('Profile save error:', err);
                showToast('Save failed');
            } finally {
                profileSaveBtn.textContent = 'Save Profile';
                profileSaveBtn.disabled = false;
            }
        });

        // ==========================================
        // HEARTBEAT (keep presence alive)
        // ==========================================
        function startHeartbeat() {
            heartbeatInterval = setInterval(() => {
                if (gameState.userId && CONFIG.huntScriptUrl) {
                    huntPost('heartbeat', { userId: gameState.userId });
                    console.log('üíì Heartbeat');
                }
            }, 5 * 60 * 1000); // Every 5 minutes
        }

        // ==========================================
        // HALL FEED RENDERING
        // ==========================================
        function renderHallFeed() {
            const listEl = document.getElementById('hallActivityList');

            if (hallFeed.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üå≤</div>
                        <div class="empty-state-text">The realm is quiet...<br>Be the first to enter.</div>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = hallFeed.map(entry => `
                <div class="game-activity">
                    <div class="game-activity-icon ${entry.icon}">${entry.emoji}</div>
                    <div class="game-activity-body">
                        <div class="game-activity-text">${entry.text}</div>
                        <div class="game-activity-meta">${getTimeAgo(entry.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // TIME HELPERS
        // ==========================================
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHrs = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHrs < 24) return `${diffHrs}h ago`;
            return `${diffDays}d ago`;
        }

        // ==========================================
        // UI RENDERING
        // ==========================================
        function renderHall() {
            // Tier badge with level
            const badge = document.getElementById('hallTierBadge');
            const tierConfig = {
                scout: { icon: 'üîç', label: 'Scout', class: 'scout' },
                hunter: { icon: 'üó°Ô∏è', label: 'Hunter', class: 'hunter' },
                tamer: { icon: 'üêâ', label: 'Tamer', class: 'tamer' },
                warden: { icon: 'üõ°Ô∏è', label: 'Warden', class: 'warden' }
            };
            const tc = tierConfig[gameState.tier];
            const lvl = gameState.level || { level: 0, xpIntoLevel: 0, xpForNextLevel: 100 };
            badge.className = `tier-badge ${tc.class}`;
            badge.innerHTML = `<span class="tier-badge-icon">${tc.icon}</span><span>${tc.label} ‚Ä¢ Lvl ${lvl.level}</span>`;

            // XP header
            document.getElementById('headerXP').textContent = gameState.totalXP.toLocaleString();

            // Level progress bar
            const pct = lvl.xpForNextLevel > 0 ? Math.round((lvl.xpIntoLevel / lvl.xpForNextLevel) * 100) : 0;
            document.getElementById('hallProgressText').textContent = `${lvl.xpIntoLevel} / ${lvl.xpForNextLevel} XP to Lvl ${lvl.level + 1}`;
            document.getElementById('hallProgressPct').textContent = pct + '%';
            document.getElementById('hallProgressFill').style.width = pct + '%';

            // Next tier hint
            const nextTiers = { scout: 'Hunter', hunter: 'Tamer', tamer: 'Warden', warden: null };
            const nextEl = document.getElementById('hallNextTier');
            nextEl.textContent = nextTiers[gameState.tier] ? `Next tier: ${nextTiers[gameState.tier]}` : 'Max tier reached';

            // Streaks
            const ss = gameState.scoutStreak;
            const sEl = document.getElementById('hallScoutStreak');
            sEl.textContent = (ss.status === 'active' ? 'üî• ' : '‚Äî ') + ss.count;
            sEl.className = `streak-value ${ss.status === 'active' ? 'streak-fire' : 'streak-dead'}`;
            
            const ssStatus = document.getElementById('hallScoutStatus');
            ssStatus.textContent = ss.status.charAt(0).toUpperCase() + ss.status.slice(1);
            ssStatus.className = `streak-status ${ss.status}`;

            const hs = gameState.hunterStreak;
            const hEl = document.getElementById('hallHunterStreak');
            if (gameState.tier === 'scout') {
                hEl.textContent = 'üîí ‚Äî';
                hEl.className = 'streak-value streak-dead';
            } else {
                hEl.textContent = (hs.status === 'active' ? 'üî• ' : '‚Äî ') + hs.count;
                hEl.className = `streak-value ${hs.status === 'active' ? 'streak-fire' : 'streak-dead'}`;
            }
        }

        function renderTracker() {
            // Tier roadmap
            const tiers = ['scout', 'hunter', 'tamer', 'warden'];
            const currentIdx = tiers.indexOf(gameState.tier);
            const progressPct = (currentIdx / (tiers.length - 1)) * 76; // 76% = visual max of bar

            document.getElementById('roadmapProgress').style.width = progressPct + '%';

            ['Scout', 'Hunter', 'Tamer', 'Warden'].forEach((name, i) => {
                const node = document.getElementById('node' + name);
                node.className = 'tier-node';
                if (i < currentIdx) node.classList.add('completed');
                if (i === currentIdx) node.classList.add('current');
            });

            // Section visibility by tier
            document.getElementById('trackerScoutSection').classList.toggle('hidden', gameState.tier !== 'scout');
            document.getElementById('trackerHunterSection').classList.toggle('hidden', gameState.tier !== 'hunter');
            document.getElementById('trackerTamerSection').classList.toggle('hidden', 
                gameState.tier === 'scout' || gameState.tier === 'hunter');

            // Calibration: hide until there's real data
            const cal = gameState.calibration;
            const hasCalData = cal.divergence !== null || cal.bias !== null || cal.multiplier !== 1.0;
            document.getElementById('trackerCalibrationSection').classList.toggle('hidden', !hasCalData);

            // Calibration values (when visible)
            document.getElementById('calDivergence').textContent = cal.divergence !== null ? cal.divergence.toFixed(1) : '‚Äî';
            document.getElementById('calBias').textContent = cal.bias !== null ? (cal.bias > 0 ? 'Over +' : 'Under ') + cal.bias.toFixed(1) : '‚Äî';
            document.getElementById('calMultiplier').textContent = cal.multiplier.toFixed(2) + '√ó';
        }

        // ==========================================
        // TERRITORY MAP (Leaflet + Triangle Selection)
        // ==========================================
        let territoryMap = null;
        let scoutMarkers = [];
        let selectedScouts = [];
        let triangleLines = [];
        let sideLabels = [];
        let scoutHistory = [];

        // Haversine for client-side distance preview
        function clientHaversine(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        document.getElementById('startTriangleBtn').addEventListener('click', async () => {
            console.log('üìê Opening territory map...');
            document.getElementById('triangleIntro').style.display = 'none';
            document.getElementById('territoryMapContainer').classList.add('active');
            document.getElementById('mapResult').style.display = 'none';

            // Load scout history if not cached
            if (scoutHistory.length === 0 && gameState.userId && CONFIG.huntScriptUrl) {
                try {
                    const result = await huntGet('getUserScoutHistory', { userId: gameState.userId });
                    if (result.status === 'success') {
                        scoutHistory = result.scouts || [];
                    }
                } catch (err) {
                    console.error('Failed to load scout history:', err);
                }
            }

            if (scoutHistory.length === 0) {
                document.getElementById('mapResult').style.display = 'block';
                document.getElementById('mapResult').className = 'map-result fail';
                document.getElementById('mapResult').innerHTML = 'No scout locations found. Go rate some locations first!';
                return;
            }

            // Init map if not exists
            if (!territoryMap) {
                territoryMap = L.map('territoryMap', {
                    zoomControl: true,
                    attributionControl: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(territoryMap);
            }

            // Clear old markers
            scoutMarkers.forEach(m => territoryMap.removeLayer(m));
            scoutMarkers = [];
            selectedScouts = [];
            clearTriangleVisuals();
            updateSelectionUI();

            // Create markers
            const bounds = L.latLngBounds();

            scoutHistory.forEach((scout, i) => {
                const latlng = L.latLng(scout.lat, scout.lon);
                bounds.extend(latlng);

                const marker = L.circleMarker(latlng, {
                    radius: 10,
                    fillColor: '#4eca8b',
                    fillOpacity: 0.8,
                    color: '#1e3828',
                    weight: 2
                }).addTo(territoryMap);

                // Rating tooltip
                const ratingText = scout.rating ? `Rating: ${scout.rating}` : 'Scout';
                const dateText = scout.timestamp ? new Date(scout.timestamp).toLocaleDateString() : '';
                marker.bindTooltip(`${ratingText}<br>${dateText}`, { 
                    direction: 'top', 
                    offset: [0, -8],
                    className: '' 
                });

                marker.scoutData = scout;
                marker.scoutIndex = i;

                marker.on('click', () => toggleScoutSelection(marker));

                scoutMarkers.push(marker);
            });

            // Fit map to markers
            if (bounds.isValid()) {
                territoryMap.fitBounds(bounds.pad(0.3));
            }

            // Invalidate size after show (Leaflet needs this)
            setTimeout(() => territoryMap.invalidateSize(), 100);
        });

        function toggleScoutSelection(marker) {
            const idx = selectedScouts.indexOf(marker);

            if (idx >= 0) {
                // Deselect
                selectedScouts.splice(idx, 1);
                marker.setStyle({ fillColor: '#4eca8b', color: '#1e3828', radius: 10 });
            } else if (selectedScouts.length < 3) {
                // Select
                selectedScouts.push(marker);
                marker.setStyle({ fillColor: '#e8b634', color: '#c49a2b', radius: 13 });
            }
            // Ignore clicks if already 3 selected

            clearTriangleVisuals();
            if (selectedScouts.length >= 2) drawTrianglePreview();
            updateSelectionUI();
        }

        function clearTriangleVisuals() {
            triangleLines.forEach(l => territoryMap.removeLayer(l));
            sideLabels.forEach(l => territoryMap.removeLayer(l));
            triangleLines = [];
            sideLabels = [];
        }

        function drawTrianglePreview() {
            const pts = selectedScouts.map(m => m.getLatLng());
            const data = selectedScouts.map(m => m.scoutData);

            // Draw lines between all selected points
            const pairs = selectedScouts.length === 3
                ? [[0,1], [1,2], [2,0]]
                : [[0,1]];

            pairs.forEach(([a, b]) => {
                const dist = clientHaversine(data[a].lat, data[a].lon, data[b].lat, data[b].lon);
                const inRange = dist >= 0.5 && dist <= 1.0;

                // Line
                const line = L.polyline([pts[a], pts[b]], {
                    color: inRange ? '#4eca8b' : '#ef4444',
                    weight: 3,
                    dashArray: inRange ? null : '8, 6',
                    opacity: 0.8
                }).addTo(territoryMap);
                triangleLines.push(line);

                // Distance label at midpoint
                const midLat = (pts[a].lat + pts[b].lat) / 2;
                const midLng = (pts[a].lng + pts[b].lng) / 2;

                const label = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: '',
                        html: `<span class="map-side-label ${inRange ? '' : 'fail'}">${dist.toFixed(2)} mi</span>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(territoryMap);
                sideLabels.push(label);
            });
        }

        function updateSelectionUI() {
            document.getElementById('mapSelCount').textContent = selectedScouts.length;
            const btn = document.getElementById('mapValidateBtn');
            if (selectedScouts.length === 3) {
                btn.classList.add('ready');
            } else {
                btn.classList.remove('ready');
            }
        }

        // Back button
        document.getElementById('mapBackBtn').addEventListener('click', () => {
            document.getElementById('territoryMapContainer').classList.remove('active');
            document.getElementById('triangleIntro').style.display = 'block';
            document.getElementById('mapResult').style.display = 'none';
        });

        // Validate button
        document.getElementById('mapValidateBtn').addEventListener('click', async () => {
            if (selectedScouts.length !== 3) return;

            const btn = document.getElementById('mapValidateBtn');
            btn.textContent = 'Validating...';
            btn.classList.remove('ready');

            const points = selectedScouts.map(m => ({
                sessionId: m.scoutData.sessionId,
                lat: m.scoutData.lat,
                lon: m.scoutData.lon
            }));

            try {
                const result = await huntPost('validateTriangle', {
                    userId: gameState.userId,
                    points: points
                });

                const resultDiv = document.getElementById('mapResult');
                resultDiv.style.display = 'block';

                if (result.valid) {
                    resultDiv.className = 'map-result success';
                    resultDiv.innerHTML = `<strong>‚öîÔ∏è Territory Proven!</strong><br>
                        Sides: ${result.sides.map(s => s + ' mi').join(' ‚Ä¢ ')}<br>
                        You've unlocked <strong>Hunter</strong> class!`;

                    // Update local state
                    gameState.tier = 'hunter';
                    renderHall();
                    renderTracker();
                    renderGameState();

                    // Re-enter the hunt to get fresh state
                    if (CONFIG.huntScriptUrl) {
                        setTimeout(() => fireEnterTheHunt(), 1500);
                    }
                } else {
                    resultDiv.className = 'map-result fail';
                    resultDiv.innerHTML = `<strong>Triangle invalid</strong><br>${(result.failReasons || []).join('<br>')}`;
                }
            } catch (err) {
                console.error('Triangle validation error:', err);
                document.getElementById('mapResult').style.display = 'block';
                document.getElementById('mapResult').className = 'map-result fail';
                document.getElementById('mapResult').innerHTML = 'Validation failed ‚Äî check your connection.';
            }

            btn.textContent = 'Validate Triangle';
            if (selectedScouts.length === 3) btn.classList.add('ready');
        });

        // ==========================================
        // DEMO DATA (placeholder until endpoints exist)
        // ==========================================
        function loadDemoData() {
            gameState.totalXP = 342;
            gameState.tier = 'scout';
            gameState.scoutStreak = { count: 7, status: 'active' };
            gameState.hunterStreak = { count: 0, status: 'locked' };
            gameState.calibration = { divergence: 1.8, bias: -0.4, multiplier: 1.10 };

            // Demo who-list (live presence)
            const now = new Date();
            whoList = [
                { userId: 'demo_jeff', handle: 'MightyJeff', tier: 'scout', enteredAt: new Date(now - 42 * 60000).toISOString(), lastHeartbeat: new Date(now - 42 * 60000).toISOString() },
                { userId: 'demo_pirates', handle: 'Pirates17', tier: 'scout', enteredAt: new Date(now - 3 * 60000).toISOString(), lastHeartbeat: new Date(now - 3 * 60000).toISOString() },
                { userId: 'demo_jejones', handle: 'jejones', tier: 'scout', enteredAt: new Date(now - 18 * 60000).toISOString(), lastHeartbeat: new Date(now - 18 * 60000).toISOString() }
            ];

            // Demo Hall feed (global events ‚Äî no personal XP)
            hallFeed = [
                {
                    icon: 'realm',
                    emoji: 'üåø',
                    text: 'Pirates17 entered the realm',
                    timestamp: new Date(now - 3 * 60000).toISOString()
                },
                {
                    icon: 'realm',
                    emoji: 'üåø',
                    text: 'jejones entered the realm',
                    timestamp: new Date(now - 18 * 60000).toISOString()
                },
                {
                    icon: 'streak',
                    emoji: 'üî•',
                    text: 'MightyJeff hit a 14-day scout streak!',
                    timestamp: new Date(now - 35 * 60000).toISOString()
                },
                {
                    icon: 'realm',
                    emoji: 'üåø',
                    text: 'MightyJeff entered the realm',
                    timestamp: new Date(now - 42 * 60000).toISOString()
                },
                {
                    icon: 'validated',
                    emoji: '‚úì',
                    text: 'Pirates17 had a scout rating validated',
                    timestamp: new Date(now - 2 * 3600000).toISOString()
                },
                {
                    icon: 'realm-exit',
                    emoji: 'üö™',
                    text: 'CLTcollector departed the realm',
                    timestamp: new Date(now - 3 * 3600000).toISOString()
                },
                {
                    icon: 'tier',
                    emoji: '‚öîÔ∏è',
                    text: 'MightyJeff has proven their territory ‚Äî Hunter unlocked!',
                    timestamp: new Date(now - 5 * 3600000).toISOString()
                },
                {
                    icon: 'event',
                    emoji: 'üìØ',
                    text: 'Cleanup event started: Fairview Ave Saturday Sweep',
                    timestamp: new Date(now - 24 * 3600000).toISOString()
                },
                {
                    icon: 'realm',
                    emoji: 'üåø',
                    text: 'CLTcollector entered the realm',
                    timestamp: new Date(now - 26 * 3600000).toISOString()
                }
            ];

            // Demo ledger (personal XP ‚Äî unchanged)
            const ledgerHTML = `
                <div class="ledger-entry">
                    <div class="ledger-entry-top">
                        <span class="ledger-entry-source">Scout Validated Bonus</span>
                        <span class="ledger-entry-xp">+45 XP</span>
                    </div>
                    <div class="ledger-entry-detail">Oak Park ‚Ä¢ Rating accuracy: 0.8 divergence</div>
                    <div class="ledger-entry-breakdown">
                        Base bonus: 50 XP<br>
                        Accuracy band (0.5‚Äì1.5): 40 XP<br>
                        Calibration √ó1.10: 45 XP
                    </div>
                </div>
                <div class="ledger-entry">
                    <div class="ledger-entry-top">
                        <span class="ledger-entry-source">Scout Streak Day 7</span>
                        <span class="ledger-entry-xp">+24 XP</span>
                    </div>
                    <div class="ledger-entry-detail">Daily streak ‚Ä¢ Base 10 + escalation 12</div>
                    <div class="ledger-entry-breakdown">
                        Base XP: 10<br>
                        Escalation (+2/day √ó 6): +12<br>
                        Calibration √ó1.10: 24.2 ‚Üí 24 XP
                    </div>
                </div>
                <div class="ledger-entry">
                    <div class="ledger-entry-top">
                        <span class="ledger-entry-source">Scout Streak Day 6</span>
                        <span class="ledger-entry-xp">+22 XP</span>
                    </div>
                    <div class="ledger-entry-detail">Daily streak ‚Ä¢ Base 10 + escalation 10</div>
                    <div class="ledger-entry-breakdown">
                        Base XP: 10<br>
                        Escalation (+2/day √ó 5): +10<br>
                        Calibration √ó1.10: 22 XP
                    </div>
                </div>
            `;
            document.getElementById('ledgerEntries').innerHTML = ledgerHTML;
            document.getElementById('ledgerTotal').textContent = '342 XP';

            // Demo leaderboard
            const ranksHTML = `
                <div class="rank-entry">
                    <span class="rank-position gold">1</span>
                    <div class="rank-user">
                        <div class="rank-handle">MightyJeff</div>
                        <div class="rank-tier">üîç Scout</div>
                    </div>
                    <span class="rank-xp">1,247 XP</span>
                </div>
                <div class="rank-entry self">
                    <span class="rank-position silver">2</span>
                    <div class="rank-user">
                        <div class="rank-handle">Pirates17</div>
                        <div class="rank-tier">üîç Scout</div>
                    </div>
                    <span class="rank-xp">342 XP</span>
                </div>
                <div class="rank-entry">
                    <span class="rank-position bronze">3</span>
                    <div class="rank-user">
                        <div class="rank-handle">jejones</div>
                        <div class="rank-tier">üîç Scout</div>
                    </div>
                    <span class="rank-xp">189 XP</span>
                </div>
            `;
            document.getElementById('ranksList').innerHTML = ranksHTML;

            // Progress bar
            document.getElementById('hallProgressText').textContent = '342 / 500 XP';
            document.getElementById('hallProgressPct').textContent = '68%';
            document.getElementById('hallProgressFill').style.width = '68%';
        }

        // ==========================================
        // INIT
        // ==========================================
        window.addEventListener('load', () => {
            const hasAuth = loadAuth();
            const params = new URLSearchParams(window.location.search);

            // Check if returning from CHIMERA action
            if (params.get('completed')) {
                const action = params.get('completed');
                const sessionId = params.get('sessionId');
                console.log(`üéØ Returned from CHIMERA: ${action} (session: ${sessionId})`);
                // Clean URL before firing sync
                window.history.replaceState({}, '', window.location.pathname);
            }

            if (hasAuth && CONFIG.huntScriptUrl) {
                // Fire real API
                fireEnterTheHunt();
            } else if (params.get('demo') !== null) {
                // Demo mode (explicit only via ?demo)
                console.warn('Demo mode: loading sample data.');
                loadDemoData();
                renderHall();
                renderWhoList();
                renderHallFeed();
                renderTracker();
            } else {
                // No auth ‚Äî show gate
                document.querySelector('.content').innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px;">Enter Through CHIMERA</div>
                        <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px; max-width: 280px;">
                            The Hunt requires an active CHIMERA session. Log in to CHIMERA first, then enter the Hunt from there.
                        </div>
                        <a href="${CONFIG.chimeraUrl}" style="padding: 12px 28px; background: var(--success); color: var(--bg-deep); border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none;">Go to CHIMERA</a>
                    </div>
                `;
                return;
            }

            startHeartbeat();
        });
    </script>
</body>
</html>
