<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIMERA Admin - Neighborhood Management</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 100px);
        }

        /* SIDEBAR */
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .sidebar h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #2D5F3F;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .btn:hover {
            background: #234a32;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        /* NEIGHBORHOOD LIST */
        .neighborhood-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .neighborhood-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .neighborhood-item:hover {
            border-color: #2D5F3F;
            background: #f0f9f4;
        }

        .neighborhood-item.selected {
            border-color: #2D5F3F;
            background: #e8f4ed;
        }

        .neighborhood-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .neighborhood-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        /* MAP PANEL */
        .map-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .map-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-controls button {
            padding: 8px 16px;
            background: #2D5F3F;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .map-controls button:hover {
            background: #234a32;
        }

        .map-controls button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        /* FORM */
        .form-section {
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-section input:focus {
            outline: none;
            border-color: #2D5F3F;
        }

        .helper-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Neighborhood Management</h1>
        
        <div class="layout">
            <!-- SIDEBAR -->
            <div class="sidebar">
                <h2>Neighborhoods</h2>
                
                <button class="btn" onclick="startNewNeighborhood()">
                    + Create New Neighborhood
                </button>
                
                <div id="neighborhoodList" class="neighborhood-list">
                    <div class="empty-state">
                        Loading neighborhoods...
                    </div>
                </div>
                
                <!-- EDIT FORM (hidden by default) -->
                <div id="editForm" style="display: none;">
                    <h2 style="margin-top: 20px;">Edit Neighborhood</h2>
                    
                    <div class="form-section">
                        <label>Neighborhood Name</label>
                        <input type="text" id="editName" placeholder="Capitol Heights">
                    </div>
                    
                    <button class="btn" onclick="saveNeighborhood()" style="margin-top: 15px;">
                        Save Changes
                    </button>
                    
                    <button class="btn btn-danger" onclick="deleteNeighborhood()">
                        Delete Neighborhood
                    </button>
                    
                    <button class="btn btn-secondary" onclick="cancelEdit()">
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- MAP PANEL -->
            <div class="map-panel">
                <div class="map-header">
                    <h2 id="mapTitle">Montgomery Area Map</h2>
                    <div class="map-controls">
                        <button id="saveBtn" onclick="saveNewNeighborhood()" style="display: none;">
                            üíæ Save Neighborhood
                        </button>
                    </div>
                </div>
                
                <div id="statusMessage"></div>
                
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // CONFIGURATION
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxyZSKDx1Z_cVeyNTQCRNqiWIhX8Caju1dUdcCLByxxIEvzDQXaYJNzcZxfW1TeTlZT/exec';  // Replace with your deployed URL
        const DEFAULT_CENTER = [32.3668, -86.2999];  // Montgomery, AL [lat, lng]
        const DEFAULT_ZOOM = 12;
        
        // STATE
        let map;
        let drawnItems;
        let drawControl;
        let currentPolygon = null;
        let selectedNeighborhood = null;
        let neighborhoods = [];
        let isCreatingNew = false;
        let neighborhoodLayers = {};
        
        // INITIALIZE MAP
        function initMap() {
            // Create map
            map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Layer to store drawn items
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Drawing control (initially hidden)
            drawControl = new L.Control.Draw({
                draw: {
                    polygon: {
                        shapeOptions: {
                            color: '#2D5F3F',
                            fillOpacity: 0.3
                        },
                        allowIntersection: false,
                        showArea: true
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            // Event: polygon drawn
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);
                currentPolygon = layer;
                
                document.getElementById('saveBtn').style.display = 'inline-block';
                showStatus('Boundary drawn! Click "Save Neighborhood" to name and save.', 'info');
            });
            
            // Event: polygon edited
            map.on(L.Draw.Event.EDITED, function(e) {
                showStatus('Boundary updated. Click "Save Neighborhood" to save changes.', 'info');
            });
            
            // Load existing neighborhoods
            loadNeighborhoods();
        }
        
        // LOAD NEIGHBORHOODS
        async function loadNeighborhoods() {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list_neighborhoods' })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    neighborhoods = result.data.neighborhoods;
                    renderNeighborhoodList();
                    
                    // Draw existing neighborhoods on map
                    neighborhoods.forEach(nbhd => {
                        drawNeighborhoodOnMap(nbhd);
                    });
                }
            } catch (error) {
                showStatus('Error loading neighborhoods: ' + error.message, 'error');
            }
        }
        
        // RENDER NEIGHBORHOOD LIST
        function renderNeighborhoodList() {
            const list = document.getElementById('neighborhoodList');
            
            if (neighborhoods.length === 0) {
                list.innerHTML = '<div class="empty-state">No neighborhoods defined yet.<br>Click "Create New" to start.</div>';
                return;
            }
            
            list.innerHTML = '';
            
            neighborhoods.forEach(nbhd => {
                const item = document.createElement('div');
                item.className = 'neighborhood-item';
                if (selectedNeighborhood && selectedNeighborhood.neighborhoodId === nbhd.neighborhoodId) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <div class="neighborhood-name">${nbhd.name}</div>
                    <div class="neighborhood-meta">
                        Created ${new Date(nbhd.dateCreated).toLocaleDateString()}
                    </div>
                `;
                
                item.onclick = () => selectNeighborhood(nbhd);
                
                list.appendChild(item);
            });
        }
        
        // DRAW NEIGHBORHOOD ON MAP
        function drawNeighborhoodOnMap(nbhd) {
            const geoJSON = JSON.parse(nbhd.boundaryGeoJSON);
            
            // Leaflet expects [lat, lng] but GeoJSON is [lng, lat]
            const coords = geoJSON.coordinates[0].map(coord => [coord[1], coord[0]]);
            
            const polygon = L.polygon(coords, {
                color: '#2D5F3F',
                fillOpacity: 0.15,
                weight: 1.5
            }).addTo(map);
            
            // Label at center
            const marker = L.marker([nbhd.centerLat, nbhd.centerLon], {
                icon: L.divIcon({
                    className: 'neighborhood-label',
                    html: `<div style="background: white; padding: 4px 8px; border-radius: 4px; border: 2px solid #2D5F3F; font-weight: 600; font-size: 12px; white-space: nowrap;">${nbhd.name}</div>`,
                    iconSize: [100, 20]
                })
            }).addTo(map);
            
            // Store for later reference
            neighborhoodLayers[nbhd.neighborhoodId] = { polygon, marker };
        }
        
        // START NEW NEIGHBORHOOD
        function startNewNeighborhood() {
            isCreatingNew = true;
            selectedNeighborhood = null;
            
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('mapTitle').textContent = 'Draw New Neighborhood Boundary';
            
            // Clear any existing drawn polygon
            drawnItems.clearLayers();
            currentPolygon = null;
            
            // Enable drawing
            map.addControl(drawControl);
            
            renderNeighborhoodList();
            
            showStatus('Use the polygon tool (top left) to draw the neighborhood boundary.', 'info');
        }
        
        // SAVE NEW NEIGHBORHOOD
        async function saveNewNeighborhood() {
            const name = prompt('Enter neighborhood name:');
            
            if (!name || name.trim() === '') {
                alert('Name is required');
                return;
            }
            
            if (!currentPolygon) {
                alert('Please draw a boundary first');
                return;
            }
            
            // Convert polygon to GeoJSON
            const latlngs = currentPolygon.getLatLngs()[0];
            const coordinates = [];
            
            latlngs.forEach(latlng => {
                coordinates.push([latlng.lng, latlng.lat]);  // GeoJSON is [lng, lat]
            });
            
            // Close the polygon
            coordinates.push(coordinates[0]);
            
            const geoJSON = {
                type: 'Polygon',
                coordinates: [coordinates]
            };
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create_neighborhood',
                        name: name,
                        boundaryGeoJSON: JSON.stringify(geoJSON),
                        adminUserId: 'admin_user'  // Replace with actual admin user ID if you have one
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('Neighborhood created successfully!', 'success');
                    
                    // Reset
                    drawnItems.clearLayers();
                    currentPolygon = null;
                    isCreatingNew = false;
                    document.getElementById('saveBtn').style.display = 'none';
                    document.getElementById('mapTitle').textContent = 'Montgomery Area Map';
                    
                    // Remove draw control
                    map.removeControl(drawControl);
                    
                    // Reload
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showStatus('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Error saving neighborhood: ' + error.message, 'error');
            }
        }
        
        // SELECT NEIGHBORHOOD
        function selectNeighborhood(nbhd) {
            selectedNeighborhood = nbhd;
            renderNeighborhoodList();
            
            // Show edit form
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('editName').value = nbhd.name;
            
            // Center map on neighborhood
            map.setView([nbhd.centerLat, nbhd.centerLon], 14);
            
            // Highlight polygon
            if (neighborhoodLayers[nbhd.neighborhoodId]) {
                const layer = neighborhoodLayers[nbhd.neighborhoodId].polygon;
                layer.setStyle({ fillOpacity: 0.4, weight: 3 });
                
                // Reset other polygons
                Object.keys(neighborhoodLayers).forEach(id => {
                    if (id !== nbhd.neighborhoodId) {
                        neighborhoodLayers[id].polygon.setStyle({ fillOpacity: 0.15, weight: 1.5 });
                    }
                });
            }
        }
        
        // SAVE EDITED NEIGHBORHOOD
        async function saveNeighborhood() {
            const newName = document.getElementById('editName').value.trim();
            
            if (!newName) {
                alert('Name is required');
                return;
            }
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_neighborhood',
                        neighborhoodId: selectedNeighborhood.neighborhoodId,
                        name: newName
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('Neighborhood updated!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showStatus('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Error updating: ' + error.message, 'error');
            }
        }
        
        // DELETE NEIGHBORHOOD
        async function deleteNeighborhood() {
            if (!confirm('Are you sure you want to delete "' + selectedNeighborhood.name + '"?')) {
                return;
            }
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete_neighborhood',
                        neighborhoodId: selectedNeighborhood.neighborhoodId
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('Neighborhood deleted!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showStatus('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showStatus('Error deleting: ' + error.message, 'error');
            }
        }
        
        // CANCEL EDIT
        function cancelEdit() {
            selectedNeighborhood = null;
            document.getElementById('editForm').style.display = 'none';
            renderNeighborhoodList();
            
            // Reset all polygon styles
            Object.keys(neighborhoodLayers).forEach(id => {
                neighborhoodLayers[id].polygon.setStyle({ fillOpacity: 0.15, weight: 1.5 });
            });
        }
        
        // SHOW STATUS MESSAGE
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-message status-' + type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // INITIALIZE ON LOAD
        window.onload = initMap;
    </script>
</body>
</html>
