<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CHIMERA - Unified Tracking V5.5</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: #2D5F3F;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hamburger {
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            user-select: none;
            transition: transform 0.2s;
        }
        .hamburger:hover { transform: scale(1.1); }
        .hamburger-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #dc2626;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .hamburger { position: relative; }
        
        .header-content { flex: 1; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header .subtitle { font-size: 11px; opacity: 0.9; margin-top: 2px; }

        /* ==================== HAMBURGER MENU ==================== */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .menu-overlay.show { display: block; opacity: 1; }
        
        .slide-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            z-index: 999;
            transition: left 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 12px rgba(0,0,0,0.15);
        }
        .slide-menu.show { left: 0; }
        
        .menu-header {
            background: #2D5F3F;
            color: white;
            padding: 20px 16px;
        }
        .menu-username {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .menu-edit {
            font-size: 13px;
            font-style: italic;
            opacity: 0.9;
            cursor: pointer;
        }
        .menu-edit:hover { text-decoration: underline; }
        
        .menu-section {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            color: #1f2937;
            transition: background 0.2s;
        }
        .menu-item:hover { background: #f9fafb; }
        .menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .menu-item-icon { font-size: 20px; width: 24px; text-align: center; }
        
        .menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 8px 16px;
        }

        .menu-lockout-banner {
            background: #1e293b;
            color: #f1f5f9;
            padding: 12px 16px;
            margin: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            display: none;
        }
        .menu-lockout-banner.show { display: block; }
        .menu-lockout-banner .lockout-icon { font-size: 20px; margin-bottom: 4px; }
        .menu-lockout-banner .lockout-title { font-weight: 600; margin-bottom: 2px; }
        .menu-lockout-banner .lockout-detail { font-size: 11px; color: #94a3b8; }

        /* ==================== CONTENT ==================== */
        .content {
            padding: 16px;
            padding-bottom: 80px;
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 70px;
            right: -350px;
            width: 320px;
            z-index: 1000;
            transition: right 0.3s ease;
        }
        .toast-container.show { right: 16px; }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid #10b981;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        
        .toast-icon { font-size: 20px; }
        .toast-message { flex: 1; font-size: 14px; color: #1f2937; font-weight: 500; }

        /* ==================== ACTIVITY FEED ==================== */
        .activity-feed {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .feed-header {
            padding: 16px;
            border-bottom: 2px solid #e5e7eb;
            background: #f9fafb;
        }
        .feed-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feed-scroll {
            max-height: 60vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .feed-sticky-item {
            padding: 12px 16px;
            background: #fef3c7;
            border-bottom: 1px solid #fbbf24;
        }
        .feed-sticky-item.accuracy {
            background: #f0f9f4;
            border-bottom: 1px solid #10b981;
        }
        .feed-sticky-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #92400e;
        }
        .feed-sticky-item.accuracy .feed-sticky-header {
            color: #065f46;
        }
        .feed-sticky-detail {
            font-size: 12px;
            color: #78350f;
            margin-top: 4px;
            margin-left: 28px;
        }
        .feed-sticky-item.accuracy .feed-sticky-detail {
            color: #047857;
        }
        .accuracy-value {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
            margin-left: 28px;
        }

        /* Feed Banners */
        .feed-banner {
            padding: 12px 16px;
            margin: 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            line-height: 1.4;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .feed-banner.info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        .feed-banner.success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            color: #166534;
            border-left: 3px solid #22c55e;
        }
        .feed-banner.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-left: 3px solid #f59e0b;
        }
        .feed-banner.event {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            color: #6b21a8;
            border-left: 3px solid #a855f7;
        }
        .feed-banner-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        .feed-banner-text {
            flex: 1;
        }
        
        .activity-item {
            padding: 14px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            line-height: 1.4;
        }
        .activity-item:last-child { border-bottom: none; }
        
        .activity-header {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .activity-icon { font-size: 16px; flex-shrink: 0; }
        .activity-text {
            font-size: 14px;
            color: #1f2937;
            flex: 1;
        }
        .activity-text strong, .activity-volunteer {
            font-weight: 600;
        }
        .activity-time {
            font-size: 13px;
            color: #6b7280;
        }
        .district-badge {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .activity-details {
            color: #4b5563;
            margin-top: 4px;
            margin-left: 24px;
        }
        
        .validation-box {
            margin-top: 10px;
            margin-left: 24px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #2D5F3F;
        }
        .validation-header {
            font-size: 11px;
            font-weight: 700;
            color: #2D5F3F;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }
        .validation-line {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 3px;
        }
        .validation-line:last-child { margin-bottom: 0; }
        .validation-line strong { color: #1f2937; }
        .validation-line.spot-on { color: #059669; }
        .validation-line.under { color: #0284c7; }
        .validation-line.over { color: #dc2626; }
        
        .no-validation {
            margin-top: 6px;
            margin-left: 24px;
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
        }

        /* ==================== UPCOMING EVENTS ==================== */
        .upcoming-events {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
            margin-bottom: 20px;
        }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-content {
            padding: 20px;
            line-height: 1.7;
            font-size: 14px;
            color: #374151;
        }
        .modal-content h4 {
            font-size: 15px;
            color: #1f2937;
            margin: 16px 0 8px;
        }
        .modal-content h4:first-child { margin-top: 0; }
        .modal-content ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 2px solid #e5e7eb;
            background: #f9fafb;
            position: sticky;
            bottom: 0;
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #2D5F3F;
            color: white;
        }
        .btn-primary:hover {
            background: #234a31;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: white;
            color: #2D5F3F;
            border: 2px solid #2D5F3F;
            margin-top: 10px;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== FORMS ==================== */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            color: #1f2937;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2D5F3F;
        }

        /* ==================== UTILITY ==================== */
        .hidden { display: none !important; }
        
        .instructions {
            background: #f0f9f4;
            border: 1px solid #d1fae5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #065f46;
            line-height: 1.6;
        }

        /* Safety checkbox */
        .safety-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-top: 12px;
        }
        .safety-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .safety-checkbox label {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }

        /* PIN toggle */
        .pin-input-wrapper { position: relative; }
        .pin-input-wrapper input { padding-right: 45px; }
        .pin-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: #6b7280;
            user-select: none;
        }
        .pin-toggle:hover { color: #2D5F3F; }

        /* Status box */
        .status-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        .status-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        .status-value {
            font-size: 16px;
            color: #1f2937;
            font-weight: 700;
        }
        .status-value.tracking { color: #2D5F3F; }

        /* Rating slider */
        .rating-scale {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #6b7280;
        }
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #4CAF50, #FF9800, #F44336);
            -webkit-appearance: none;
            appearance: none;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #2D5F3F;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #2D5F3F;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .slider.untouched {
            opacity: 0.5;
        }
        .rating-value {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            color: #2D5F3F;
            margin-bottom: 6px;
        }
        .rating-value.untouched {
            color: #9ca3af;
        }
        .rating-description {
            text-align: center;
            font-size: 13px;
            color: #6b7280;
        }

        /* Bags */
        .bag-entry {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .bag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .bag-number {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        .remove-bag {
            color: #dc2626;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
        }
        .add-bag-btn {
            width: 100%;
            padding: 10px;
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
        }
        .add-bag-btn:hover {
            border-color: #2D5F3F;
            color: #2D5F3F;
        }

        /* Consent */
        .consent-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .consent-title {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
        }
        .consent-question {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .consent-question:last-child { margin-bottom: 0; }
        .consent-label {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            display: block;
        }
        .consent-options {
            display: flex;
            gap: 16px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .radio-option input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .radio-option label {
            font-size: 13px;
            color: #1f2937;
            cursor: pointer;
        }

        /* Notes */
        .notes-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #1f2937;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: #2D5F3F;
        }
        .char-counter {
            font-size: 11px;
            color: #9ca3af;
            text-align: right;
            margin-top: 4px;
        }

        /* Login cards */
        .login-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .login-card h3 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .login-sub {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 16px;
        }
        .login-toggle {
            text-align: center;
            font-size: 13px;
            color: #2D5F3F;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 600;
        }
        .login-toggle:hover { text-decoration: underline; }

        /* Custom org input */
        .custom-org-input {
            margin-top: 12px;
            display: none;
        }
        .custom-org-input.show { display: block; }

        /* Photo section */
        .photo-section { margin-bottom: 16px; }
        .photo-btn {
            width: 100%;
            padding: 14px;
            border: 2px dashed #d1d5db;
            background: #fafafa;
            border-radius: 8px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .photo-btn:hover {
            border-color: #2D5F3F;
            background: #f5f5f5;
        }
        .photo-count {
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        /* Address card */
        .address-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .address-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .address-type-badge {
            background: #2D5F3F;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .address-actions {
            display: flex;
            gap: 8px;
        }
        .address-action {
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
        }
        .address-action:hover { color: #2D5F3F; }
        .address-action.delete:hover { color: #dc2626; }
        .address-text {
            font-size: 13px;
            color: #4b5563;
        }

        /* Household Recycling */
        .scale-tip {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #1e40af;
            line-height: 1.5;
        }

        .info-dropdown-toggle {
            text-align: center;
            font-size: 13px;
            color: #2D5F3F;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .info-dropdown-toggle:hover { text-decoration: underline; }
        .info-dropdown-pane {
            display: none;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .info-dropdown-pane.show { display: block; }
        .info-dropdown-pane h4 {
            font-size: 15px;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .info-dropdown-pane p {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        /* Site Pause Overlay */
        .site-pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .site-pause-overlay.show { display: flex; }
        .site-pause-content {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }
        .site-pause-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .site-pause-title {
            font-size: 24px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 12px;
        }
        .site-pause-message {
            font-size: 16px;
            color: #e5e7eb;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- ==================== SITE PAUSE OVERLAY ==================== -->
    <div class="site-pause-overlay" id="sitePauseOverlay">
        <div class="site-pause-content">
            <div class="site-pause-icon">üöß</div>
            <div class="site-pause-title">CHIMERA is Temporarily Unavailable</div>
            <div class="site-pause-message" id="sitePauseMessage">We'll be back soon.</div>
        </div>
    </div>

    <!-- ==================== HAMBURGER MENU ==================== -->
    <div class="menu-overlay" id="menuOverlay"></div>
    <div class="slide-menu" id="slideMenu">
        <div class="menu-header">
            <div class="menu-username" id="menuUsername">Volunteer</div>
            <div class="menu-edit" id="menuEditProfile">edit profile</div>
        </div>
        
        <!-- Event Coordinator Section (hidden by default) - SPECIAL STYLING -->
        <div class="menu-section" id="coordinatorMenuSection" style="display: none;">
            <div class="menu-item" id="menuEventManager" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; margin: 4px 0;">
                <span class="menu-item-icon">‚≠ê</span>
                <span style="color: #92400e; font-weight: 600;">Event Manager</span>
            </div>
        </div>
        
        <div class="menu-divider" id="coordinatorDivider" style="display: none;"></div>

        <!-- Lockout Banner (shown when sun-locked) -->
        <div class="menu-lockout-banner" id="menuLockoutBanner">
            <div class="lockout-icon">üåô</div>
            <div class="lockout-title">Outdoor Tracking Unavailable</div>
            <div class="lockout-detail">Disabled after sunset for safety.<br>Next sunrise: <span id="menuLockoutSunrise">--:--</span></div>
        </div>

        <!-- ACTION Section -->
        <div class="menu-section-title" style="font-size: 11px; color: #6b7280; font-weight: 600; padding: 8px 16px 4px; text-transform: uppercase;">Actions</div>
        <div class="menu-section">
            <div class="menu-item" id="menuGettingStarted">
                <span class="menu-item-icon">üí°</span>
                <span>Getting Started</span>
            </div>
            <div class="menu-item" id="menuScout">
                <span class="menu-item-icon">üîç</span>
                <span>Rate Location</span>
            </div>
            <div class="menu-item disabled" id="menuPin">
                <span class="menu-item-icon">üìç</span>
                <span>Pin Location (coming soon)</span>
            </div>
            <div class="menu-item" id="menuTrack">
                <span class="menu-item-icon">üóëÔ∏è</span>
                <span>Live Track: ‚àöCPUE</span>
            </div>
            <div class="menu-item" id="menuRecycle">
                <span class="menu-item-icon">‚ôªÔ∏è</span>
                <span>Recycle</span>
            </div>
            <div class="menu-item disabled" id="menuCompost">
                <span class="menu-item-icon">üå±</span>
                <span>Composting (coming soon)</span>
            </div>
        </div>
        
        <div class="menu-divider"></div>

        <!-- INFORMATION Section -->
        <div class="menu-section-title" style="font-size: 11px; color: #6b7280; font-weight: 600; padding: 8px 16px 4px; text-transform: uppercase;">Information</div>
        <div class="menu-section">
            <div class="menu-item" id="menuActivityFeed">
                <span class="menu-item-icon">üìä</span>
                <span>Activity Feed</span>
            </div>
            <div class="menu-item" id="menuUpcomingEvents">
                <span class="menu-item-icon">üìÜ</span>
                <span>Upcoming Events</span>
            </div>
            <div class="menu-item" id="menuWiki">
                <span class="menu-item-icon">üìö</span>
                <span>CHIMERAwiki</span>
            </div>
            <div class="menu-item" id="menuFieldTest">
                <span class="menu-item-icon">üó∫Ô∏è</span>
                <span>Field Test Map</span>
            </div>
            <div class="menu-item" id="menuDemo">
                <span class="menu-item-icon">üêæ</span>
                <span>(DEMO) The Chimera Hunt</span>
            </div>
        </div>
        
        <div class="menu-divider"></div>
        
        <div class="menu-section">
            <div class="menu-item" id="menuLogout">
                <span class="menu-item-icon">üö™</span>
                <span>Log Out</span>
            </div>
        </div>
    </div>

    <!-- ==================== TOAST NOTIFICATIONS ==================== -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <!-- ==================== HEADER ==================== -->
        <div class="header">
            <div class="hamburger hidden" id="hamburgerBtn">‚ò∞<span class="hamburger-badge hidden" id="hamburgerBadge">0</span></div>
            <div class="header-content">
                <h1>üåç CHIMERA Tracker</h1>
                <div class="subtitle">Data Hub for Litter Scouting, Collecting & Recycling ‚Ä¢ V5.5</div>
            </div>
        </div>

        <div class="content">
            <!-- ==================== LOGIN SCREEN ==================== -->
            <div id="loginScreen">
                <div class="instructions" style="margin-bottom: 20px;">
                    <strong>Welcome to CHIMERA!</strong><br>
                    Log in or create a profile to start tracking.
                </div>

                <!-- PRE-LOGIN ACTIVITY FEED -->
                <div class="activity-feed" id="preLoginFeed">
                    <div class="feed-header">
                        <div class="feed-title">
                            <span>üìä</span> Recent Activity
                        </div>
                    </div>
                    <div class="feed-scroll" id="preLoginFeedScroll">
                        <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 40px 20px;">
                            Loading activity...
                        </div>
                    </div>
                </div>

                <!-- LOGIN FORM -->
                <div class="login-card" id="loginForm">
                    <h3>üîë Log In</h3>
                    <div class="login-sub">Enter your handle and PIN</div>

                    <div class="form-group">
                        <label class="form-label">Handle</label>
                        <input type="text" class="form-input" id="loginHandle" placeholder="Your handle (not your real name)" autocomplete="off">
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Use the handle you created, not your real name</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PIN</label>
                        <div class="pin-input-wrapper">
                            <input type="password" class="form-input" id="loginPIN" placeholder="e.g. jb07" maxlength="4" autocomplete="off" style="text-transform: lowercase;">
                            <span class="pin-toggle" onclick="togglePIN('loginPIN', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="loginBtn" disabled>Log In</button>
                    <div style="text-align: center; font-size: 12px; color: #6b7280; margin-top: 8px;">
                        Forgot your PIN? Contact your organization lead.
                    </div>
                    <div class="login-toggle" id="showCreateToggle">New here? Create a profile ‚Üí</div>
                </div>

                <!-- CREATE PROFILE FORM -->
                <div class="login-card hidden" id="createForm">
                    <h3>üìù Create Profile</h3>
                    <div class="login-sub">Choose a handle and PIN you'll remember</div>

                    <div class="form-group">
                        <label class="form-label">Choose a Handle</label>
                        <input type="text" class="form-input" id="createHandle" placeholder="Pick a nickname (not your real name)" autocomplete="off">
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">‚ö†Ô∏è This will be visible to others. Don't use your real name.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PIN (2 letters + 2 numbers)</label>
                        <div class="pin-input-wrapper">
                            <input type="password" class="form-input" id="createPIN" placeholder="e.g. jb07" maxlength="4" autocomplete="off" style="text-transform: lowercase;">
                            <span class="pin-toggle" onclick="togglePIN('createPIN', this)">üëÅÔ∏è</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Format: two letters + two numbers (e.g. km23)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <select class="form-select" id="createOrgSelect">
                            <option value="">Select your organization</option>
                            <option value="Baled It!">Baled It!</option>
                            <option value="Help A Brother Out Foundation">Help A Brother Out Foundation</option>
                            <option value="West Montgomery Action Committee">West Montgomery Action Committee</option>
                            <option value="other">Add organization...</option>
                        </select>
                        <div class="custom-org-input" id="createCustomOrg">
                            <input type="text" class="form-input" id="createCustomOrgText" placeholder="Enter organization name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (Optional)</label>
                        <input type="email" class="form-input" id="createEmail" placeholder="For event notifications only" autocomplete="off">
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">üîí Never shared publicly. Used only for event notifications if you opt in.</div>
                    </div>
                    
                    <button class="btn btn-primary" id="createProfileBtn" disabled>Create Profile</button>
                    <div class="login-toggle" id="showLoginToggle">Already have a profile? Log in ‚Üí</div>
                </div>
            </div>

            <!-- ==================== MAIN SCREEN ==================== -->
            <div id="mainScreen" class="hidden">
                <!-- Upcoming Events Banner (clickable) -->
                <div class="upcoming-events" id="upcomingEventsBanner" onclick="showUpcomingEvents()" style="cursor: pointer;">
                    üìÖ <span id="upcomingBannerText">Loading events...</span>
                </div>

                <!-- Activity Feed -->
                <div class="activity-feed">
                    <div class="feed-header">
                        <div class="feed-title">
                            <span>üìä</span> Recent Activity
                        </div>
                    </div>
                    <div class="feed-scroll" id="feedScroll">
                        <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 40px 20px;">
                            Loading activity...
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SCOUT MODE (Single Capture) ==================== -->
            <div id="scoutScreen" class="hidden">
                <div class="instructions">
                    <strong>üîç Rate Location</strong><br>
                    Capture your GPS location and rate the litter density.
                </div>

                <div class="status-box">
                    <div class="status-row">
                        <span class="status-label">üìç Location</span>
                        <span class="status-value" id="scoutGPSStatus">Capturing...</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Litter Rating (0-10)</label>
                    <div class="rating-value untouched" id="scoutRatingValue">‚Äî</div>
                    <div class="rating-description" id="scoutRatingDesc">Tap the slider to rate</div>
                    <div class="rating-scale">
                        <span>0 - Clean</span>
                        <span>5 - Moderate</span>
                        <span>10 - Severe</span>
                    </div>
                    <input type="range" class="slider untouched" id="scoutRatingSlider" min="0" max="10" value="5" step="1">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="notes-textarea" id="scoutNotes" placeholder="Describe this location ‚Äî nearby landmarks, notable features..." maxlength="500"></textarea>
                    <div class="char-counter"><span id="scoutNotesCount">0</span>/500</div>
                </div>

                <div class="consent-section">
                    <div class="consent-title">üì¢ Sharing Preferences</div>
                    <div class="consent-question">
                        <label class="consent-label">Include in public Activity Feed?</label>
                        <div class="consent-options">
                            <div class="radio-option">
                                <input type="radio" id="scoutFeedYes" name="scoutFeed" value="yes">
                                <label for="scoutFeedYes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="scoutFeedNo" name="scoutFeed" value="no">
                                <label for="scoutFeedNo">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="submitScoutBtn" disabled>Submit Scout Report</button>
                <button class="btn btn-secondary" id="cancelScoutBtn">Cancel</button>
            </div>

            <!-- ==================== ACTIVE TRACKING SCREEN ==================== -->
            <div id="activeTrackingScreen" class="hidden">
                <div class="status-box">
                    <div class="status-row">
                        <span class="status-label">üìç Tracking</span>
                        <span class="status-value tracking">Active</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">‚è±Ô∏è Duration</span>
                        <span class="status-value" id="trackingDuration">00:00</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">üìè Distance</span>
                        <span class="status-value" id="trackingDistance">0.00 mi</span>
                    </div>
                </div>

                <div class="photo-section">
                    <label for="trackingPhotoInput" class="photo-btn">üì∏ Take Photo</label>
                    <input type="file" id="trackingPhotoInput" accept="image/*" capture="environment" style="display: none;">
                    <div class="photo-count" id="trackingPhotoCount">0 photos captured</div>
                </div>

                <button class="btn btn-danger" id="stopTrackingBtn">‚èπÔ∏è Stop Tracking</button>
            </div>

            <!-- ==================== POST-TRACKING SCREEN ==================== -->
            <div id="postTrackingScreen" class="hidden">
                <div class="status-box">
                    <div class="status-row">
                        <span class="status-label">Session Complete</span>
                        <span class="status-value">‚úì</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Duration</span>
                        <span class="status-value" id="finalDuration">00:00</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Distance</span>
                        <span class="status-value" id="finalDistance">0.00 mi</span>
                    </div>
                </div>

                <h3 style="font-size: 15px; color: #1f2937; margin: 16px 0 12px;">üìä Litter Rating (Optional)</h3>
                <div class="rating-value untouched" id="postRatingValue">‚Äî</div>
                <div class="rating-description" id="postRatingDesc">Tap the slider to rate</div>
                <div class="rating-scale">
                    <span>0 - Clean</span>
                    <span>5 - Moderate</span>
                    <span>10 - Severe</span>
                </div>
                <input type="range" class="slider untouched" id="postRatingSlider" min="0" max="10" value="5" step="1">

                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="notes-textarea" id="postNotes" placeholder="Describe this location..." maxlength="500"></textarea>
                    <div class="char-counter"><span id="postNotesCount">0</span>/500</div>
                </div>

                <h3 style="font-size: 15px; color: #1f2937; margin: 20px 0 12px;">üóëÔ∏è Collection Data</h3>
                <div id="bagsContainer"></div>
                <button class="add-bag-btn" id="addBagBtn">+ Add Bag</button>

                <div class="consent-section" style="margin-top: 20px;">
                    <div class="consent-title">üì¢ Sharing Preferences</div>
                    <div class="consent-question">
                        <label class="consent-label">Include in public Activity Feed?</label>
                        <div class="consent-options">
                            <div class="radio-option">
                                <input type="radio" id="postFeedYes" name="postFeed" value="yes">
                                <label for="postFeedYes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="postFeedNo" name="postFeed" value="no">
                                <label for="postFeedNo">No</label>
                            </div>
                        </div>
                    </div>
                    <div class="consent-question hidden" id="photoConsentQuestion">
                        <label class="consent-label">Allow photos for promotional use?</label>
                        <div class="consent-options">
                            <div class="radio-option">
                                <input type="radio" id="photoConsentYes" name="photoConsent" value="yes">
                                <label for="photoConsentYes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="photoConsentNo" name="photoConsent" value="no">
                                <label for="photoConsentNo">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="submitCollectionBtn" disabled>Submit Report</button>
                <button class="btn btn-secondary" id="cancelCollectionBtn">Cancel</button>
            </div>

            <!-- ==================== EDIT PROFILE SCREEN ==================== -->
            <div id="editProfileScreen" class="hidden">
                <div class="instructions">
                    <strong>‚úèÔ∏è Edit Profile</strong><br>
                    Update your information.
                </div>

                <div class="form-group">
                    <label class="form-label">Handle</label>
                    <input type="text" class="form-input" id="editHandle" disabled style="background: #f3f4f6; color: #6b7280;">
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Handle cannot be changed</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Organization</label>
                    <select class="form-select" id="editOrgSelect">
                        <option value="Baled It!">Baled It!</option>
                        <option value="Help A Brother Out Foundation">Help A Brother Out Foundation</option>
                        <option value="West Montgomery Action Committee">West Montgomery Action Committee</option>
                        <option value="other">Other...</option>
                    </select>
                    <div class="custom-org-input" id="editCustomOrg">
                        <input type="text" class="form-input" id="editCustomOrgText" placeholder="Enter organization name">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Email (Optional)</label>
                    <input type="email" class="form-input" id="editEmail" placeholder="For event notifications only">
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">üîí Never shared publicly. Used only for event notifications if you opt in.</div>
                </div>

                <h3 style="font-size: 15px; color: #1f2937; margin: 20px 0 12px;">üìç Addresses</h3>
                <div id="addressesContainer"></div>
                <button class="add-bag-btn" id="addAddressBtn">+ Add Address</button>

                <button class="btn btn-primary" id="saveProfileBtn" style="margin-top: 20px;">Save Changes</button>
                <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
            </div>

            <!-- ==================== HOUSEHOLD RECYCLING SCREEN ==================== -->
            <div id="recycleScreen" class="hidden">
                <h2 style="font-size: 18px; margin-bottom: 16px; color: #1f2937;">‚ôªÔ∏è Log Recycling</h2>

                <div class="info-dropdown-toggle" id="hrInfoToggle">‚ÑπÔ∏è For more information on recycling locally...</div>
                <div class="info-dropdown-pane" id="hrInfoPane">
                    <h4>COMING SOON</h4>
                    <p>Recycling in Montgomery is challenging. We're working to identify accessible alternatives for residents.</p>
                </div>

                <div class="info-dropdown-toggle" id="dropoffToggle">üìç View validated dropoff locations...</div>
                <div class="info-dropdown-pane" id="dropoffPane">
                    <h4>COMING SOON</h4>
                    <p>We're building a directory of verified recycling dropoff points in Montgomery.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Material Type</label>
                    <select class="form-select" id="hrMaterialType">
                        <option value="">Select material...</option>
                        <option value="Aluminum">Aluminum (cans, foil)</option>
                        <option value="Cardboard">Cardboard</option>
                        <option value="Glass">Glass</option>
                        <option value="Paper">Paper (office, newspaper)</option>
                        <option value="Plastic #1 PET">Plastic #1 (PET - bottles)</option>
                        <option value="Plastic #2 HDPE">Plastic #2 (HDPE - jugs)</option>
                        <option value="Plastic #5 PP">Plastic #5 (PP - containers)</option>
                        <option value="Steel/Tin">Steel / Tin cans</option>
                        <option value="Mixed">Mixed recyclables</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group hidden" id="hrDescriptionWrap">
                    <label class="form-label">Description (required for Mixed/Other)</label>
                    <input type="text" class="form-input" id="hrDescription" placeholder="Describe the materials">
                </div>

                <div class="form-group">
                    <label class="form-label">Estimated Weight (lbs)</label>
                    <input type="number" class="form-input" id="hrWeight" placeholder="0.0" step="0.1" min="0">
                    <div class="scale-tip">
                        üí° <strong>No scale?</strong> Weigh yourself holding the bag, then without. Subtract.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Date Bagged/Sealed</label>
                    <input type="date" class="form-input" id="hrDateBagged">
                </div>

                <div class="form-group">
                    <label class="form-label">Where is this going?</label>
                    <select class="form-select" id="hrDestination">
                        <option value="">Select destination...</option>
                        <option value="Municipal">Municipal</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="custom-org-input" id="hrDestOtherWrap">
                        <input type="text" class="form-input" id="hrDestOther" placeholder="Describe destination">
                    </div>
                </div>

                <button class="btn btn-primary" id="submitHRBtn" disabled>Submit Recycling Log</button>
                <button class="btn btn-secondary" id="cancelHRBtn">Cancel</button>
            </div>
        </div>

        <!-- ==================== EVENT MANAGER SCREEN (Coordinator Only) ==================== -->
        <div id="eventManagerScreen" class="hidden">
            <div class="instructions">
                <strong>üìÖ Event Manager</strong><br>
                Propose and manage cleanup events. Approved events appear publicly.
            </div>

            <button class="btn btn-primary" id="proposeEventBtn" style="width: 100%; margin-bottom: 16px;">+ Propose New Event</button>

            <div class="form-group">
                <label class="form-label">My Events</label>
                <div id="myEventsList" style="background: #f9fafb; border-radius: 12px; min-height: 100px;">
                    <div style="text-align: center; color: #6b7280; padding: 30px;">Loading...</div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="backFromEventManagerBtn">‚Üê Back</button>
            </div>
        </div>

        <!-- ==================== PROPOSE EVENT SCREEN ==================== -->
        <div id="proposeEventScreen" class="hidden">
            <div class="instructions">
                <strong>üìù Propose Event</strong><br>
                Fill in event details. Admin approval required before it goes live.
            </div>

            <div class="form-group">
                <label class="form-label">Event Title *</label>
                <input type="text" class="form-input" id="eventTitleInput" placeholder="e.g., Spring Cleanup at Oak Park">
            </div>

            <div class="form-group">
                <label class="form-label">Organizing Group *</label>
                <select class="form-select" id="eventOrgSelect">
                    <option value="">Select organization...</option>
                    <option value="Baled It!">Baled It!</option>
                    <option value="Help A Brother Out Foundation">Help A Brother Out Foundation</option>
                    <option value="West Montgomery Action Committee">West Montgomery Action Committee</option>
                    <option value="other">Other...</option>
                </select>
                <div class="custom-org-input hidden" id="eventCustomOrg">
                    <input type="text" class="form-input" id="eventCustomOrgText" placeholder="Enter organization name">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Event Date *</label>
                <input type="date" class="form-input" id="eventDateInput">
            </div>

            <div style="display: flex; gap: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Start Time</label>
                    <input type="time" class="form-input" id="eventStartTimeInput">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">End Time</label>
                    <input type="time" class="form-input" id="eventEndTimeInput">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Location Name *</label>
                <input type="text" class="form-input" id="eventLocationInput" placeholder="e.g., Oak Park Pavilion">
            </div>

            <div class="form-group">
                <label class="form-label">Location Address or Coordinates</label>
                <input type="text" class="form-input" id="eventAddressInput" placeholder="123 Main St or 32.3792, -86.3077">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="notes-textarea" id="eventDescriptionInput" rows="3" placeholder="What should participants know? Parking info, what to bring, etc."></textarea>
            </div>

            <div class="consent-section" style="margin-top: 16px;">
                <div class="consent-title">üìû Event Contact (Optional)</div>
                <div class="form-group" style="margin-top: 8px;">
                    <input type="text" class="form-input" id="eventContactName" placeholder="Contact Name">
                </div>
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <input type="tel" class="form-input" id="eventContactPhone" placeholder="Phone">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="email" class="form-input" id="eventContactEmail" placeholder="Email">
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="submitEventProposalBtn">Submit for Approval</button>
                <button class="btn btn-secondary" id="cancelEventProposalBtn">Cancel</button>
            </div>
        </div>

        <!-- ==================== EVENT DETAIL SCREEN (For Coordinators) ==================== -->
        <div id="eventDetailScreen" class="hidden">
            <div class="instructions">
                <strong>üìÖ <span id="eventDetailTitle">Event Details</span></strong><br>
                <span id="eventDetailStatus" style="font-size: 12px;"></span>
            </div>

            <div class="status-box" id="eventDetailInfo">
                <div class="status-row">
                    <span class="status-label">üìÖ Date</span>
                    <span class="status-value" id="eventDetailDate">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">üïê Time</span>
                    <span class="status-value" id="eventDetailTime">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">üìç Location</span>
                    <span class="status-value" id="eventDetailLocation">-</span>
                </div>
            </div>

            <div id="eventDetailDescription" style="background: #f0fdf4; border-radius: 12px; padding: 14px; margin-bottom: 16px; display: none;">
                <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 6px;">Description</div>
                <div id="eventDetailDescText" style="color: #15803d; font-size: 14px;"></div>
            </div>

            <!-- Supplies Section (Coordinator only, approved events) -->
            <div id="suppliesSection" style="display: none;">
                <div class="consent-section">
                    <div class="consent-title">üì¶ Supplies</div>
                    <div id="suppliesList" style="margin-top: 8px;"></div>
                    <button class="btn btn-secondary" id="addSupplyBtn" style="margin-top: 8px; font-size: 13px; padding: 8px 12px;">+ Add Supply</button>
                </div>
            </div>

            <!-- Post Update (Coordinator only, approved events) -->
            <div id="postUpdateSection" style="display: none; margin-top: 16px;">
                <div class="form-group">
                    <label class="form-label">Post Update to Activity Feed</label>
                    <textarea class="notes-textarea" id="eventUpdateText" rows="2" placeholder="Share news about this event..."></textarea>
                </div>
                <button class="btn btn-primary" id="postEventUpdateBtn" style="width: 100%;">Post Update</button>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="backFromEventDetailBtn">‚Üê Back</button>
                <button class="btn btn-danger" id="cancelEventBtn" style="display: none;">Cancel Event</button>
            </div>
        </div>

        <!-- ==================== UPCOMING EVENTS SCREEN ==================== -->
        <div id="upcomingEventsScreen" class="hidden">
            <div class="instructions">
                <strong>üìÜ Upcoming Events</strong><br>
                Community cleanup events organized by volunteer coordinators.
            </div>

            <div id="upcomingEventsList" style="min-height: 100px;">
                <div style="text-align: center; color: #6b7280; padding: 30px;">Loading...</div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="backFromUpcomingBtn">‚Üê Back</button>
            </div>
        </div>

    </div>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Getting Started Modal -->
    <div class="modal-overlay" id="gettingStartedModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üí° Getting Started</div>
            </div>
            <div class="modal-content">
                <p><strong>Welcome to CHIMERA!</strong></p>
                <p>Choose a mode from the menu:</p>
                <h4>üîç Rate Location</h4>
                <p>Scout a location and rate litter density (0-10). Your ratings get validated when collectors clean nearby.</p>
                <h4>üóëÔ∏è Live Track: ‚àöCPUE</h4>
                <p>Track your cleanup with GPS. Record bags collected to calculate your efficiency score.</p>
                <h4>‚ôªÔ∏è Recycle</h4>
                <p>Log household recycling to support the case for expanded infrastructure.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="closeGettingStarted">Got It</button>
            </div>
        </div>
    </div>

    <!-- CHIMERAwiki Modal -->
    <div class="modal-overlay" id="wikiModal">
        <div class="modal" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <div class="modal-title">üìö CHIMERAwiki</div>
            </div>
            <div class="modal-content">
                <p style="color: #6b7280; font-style: italic;">A growing knowledge base for CHIMERA volunteers.</p>
                
                <div class="wiki-section" style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer;" onclick="showWikiTopic('cpue')">
                    <strong>üìä What is ‚àöCPUE?</strong>
                    <div style="font-size: 12px; color: #6b7280;">Understanding the efficiency metric</div>
                </div>
                
                <div class="wiki-section" style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer;" onclick="showWikiTopic('zones')">
                    <strong>üó∫Ô∏è Montgomery Zones</strong>
                    <div style="font-size: 12px; color: #6b7280;">How collection zones work</div>
                </div>
                
                <div class="wiki-section" style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer;" onclick="showWikiTopic('validation')">
                    <strong>‚úì Scout Validation</strong>
                    <div style="font-size: 12px; color: #6b7280;">How ratings get verified</div>
                </div>
                
                <div class="wiki-section" style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer;" onclick="showWikiTopic('safety')">
                    <strong>‚ö†Ô∏è Safety Guidelines</strong>
                    <div style="font-size: 12px; color: #6b7280;">Stay safe while collecting</div>
                </div>
                
                <div class="wiki-section" style="margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer;" onclick="showWikiTopic('privacy')">
                    <strong>üîí Privacy & Data</strong>
                    <div style="font-size: 12px; color: #6b7280;">What we collect and why</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeWiki">Close</button>
            </div>
        </div>
    </div>

    <!-- Wiki Topic Modals -->
    <div class="modal-overlay" id="wikiTopicModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="wikiTopicTitle">Topic</div>
            </div>
            <div class="modal-content" id="wikiTopicContent">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('wikiTopicModal').classList.remove('show');">Back to Wiki</button>
            </div>
        </div>
    </div>

    <!-- Safety/Legal Modal -->
    <div class="modal-overlay" id="safetyLegalModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚ö†Ô∏è Safety & Legal</div>
            </div>
            <div class="modal-content">
                <h4>Safety Guidelines</h4>
                <ul>
                    <li>Watch for traffic when crossing streets</li>
                    <li>Wear gloves when handling litter</li>
                    <li>Stay hydrated and take breaks</li>
                    <li>Work in pairs when possible</li>
                    <li><strong>Do NOT operate a vehicle while tracking</strong></li>
                    <li>Stay aware of your surroundings</li>
                    <li>Watch for hazards (glass, sharp objects, wildlife)</li>
                </ul>

                <h4>Data Collection</h4>
                <p>CHIMERA collects GPS location, litter ratings, collection weights, and photos during sessions.</p>

                <h4>Data Retention</h4>
                <p>GPS coordinates archived after validation, deleted after 30 days. Photos retained unless you request deletion.</p>

                <h4>Liability</h4>
                <p>You participate at your own risk. Always prioritize safety.</p>
                
                <div class="safety-checkbox">
                    <input type="checkbox" id="safetyLegalAck">
                    <label for="safetyLegalAck">I understand and agree</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="acceptSafetyLegal" disabled>Accept & Continue</button>
            </div>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div class="modal-overlay" id="addAddressModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üìç Add Address</div>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Address Type</label>
                    <select class="form-select" id="newAddressType">
                        <option value="Home">Home</option>
                        <option value="Work">Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Street Address</label>
                    <input type="text" class="form-input" id="newAddressStreet" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label class="form-label">Neighborhood</label>
                    <input type="text" class="form-input" id="newAddressNeighborhood" placeholder="e.g. Cloverdale">
                </div>
                <div class="form-group">
                    <label class="form-label">Zip Code</label>
                    <input type="text" class="form-input" id="newAddressZip" placeholder="36104" maxlength="5">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveNewAddress">Save Address</button>
                <button class="btn btn-secondary" id="cancelNewAddress">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // VERSION & CONFIG
        // ==========================================
        const UI_VERSION = 'V5.5-260211-1200';
        console.log('üîß CHIMERA UI Version:', UI_VERSION);

        const CONFIG = {
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycbysweOefC4Y8Ed4w_6OZzfDZ-vEoqZLqKRCboH9AivIZ_-jSbwkj70VXTRPP0jZJme0NA/exec',
            gpsInterval: 10000,
            organizations: ['Baled It!', 'Help A Brother Out Foundation', 'West Montgomery Action Committee'],
            urls: { fieldTestMap: 'feb_3_fieldtest.html', demoGame: 'gone-feral.html' }
        };

        // ==========================================
        // STATE
        // ==========================================
        let currentUser = {
            userId: null, handle: null, organization: null,
            addresses: [], safetyLegalAccepted: false, lastSafetyLegalCheck: null
        };

        let sessionState = {
            sessionId: null, isTracking: false, startTime: null,
            gpsPoints: [], photos: [], totalDistance: 0, mode: null,
            durationTimer: null, gpsTimer: null, ratingTouched: false
        };

        let bags = [];
        let bagCounter = 0;
        let sunLocked = false;

        // Hunt Integration (query parameter handshake)
        let huntIntegration = {
            fromHunt: false,
            action: null  // 'scout' or 'collect'
        };

        // Rating descriptions (5 buckets)
        const ratingDescriptions = {
            0: 'Clean/Minimal', 1: 'Clean/Minimal', 2: 'Clean/Minimal',
            3: 'Light litter', 4: 'Light litter',
            5: 'Moderate litter', 6: 'Moderate litter',
            7: 'Heavy litter', 8: 'Heavy litter',
            9: 'Severe litter', 10: 'Severe litter'
        };

        // ==========================================
        // SESSION STORAGE
        // ==========================================
        function restoreSession() {
            const saved = sessionStorage.getItem('chimera_user');
            if (saved) {
                try { currentUser = JSON.parse(saved); return true; }
                catch (e) { return false; }
            }
            return false;
        }

        function saveSession() {
            sessionStorage.setItem('chimera_user', JSON.stringify(currentUser));
        }

        function clearSession() {
            currentUser = { userId: null, handle: null, organization: null, addresses: [], safetyLegalAccepted: false, lastSafetyLegalCheck: null };
            sessionStorage.removeItem('chimera_user');
        }

        // ==========================================
        // TOAST NOTIFICATIONS
        // ==========================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†';
            toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-message">${message}</div>`;
            container.appendChild(toast);
            container.classList.add('show');
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                    if (container.children.length === 0) container.classList.remove('show');
                }, 300);
            }, 3000);
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function togglePIN(inputId, toggleElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') { input.type = 'text'; toggleElement.textContent = 'üôà'; }
            else { input.type = 'password'; toggleElement.textContent = 'üëÅÔ∏è'; }
        }

        function hideAllScreens() {
            ['loginScreen', 'mainScreen', 'scoutScreen', 'activeTrackingScreen', 
             'postTrackingScreen', 'editProfileScreen', 'recycleScreen',
             'eventManagerScreen', 'proposeEventScreen', 'upcomingEventsScreen', 'eventDetailScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatTimeShort(date) {
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const h = date.getHours().toString().padStart(2, '0');
            const min = date.getMinutes().toString().padStart(2, '0');
            return `${m}/${d} ${h}:${min}`;
        }

        function formatTimeVague(date) {
            const now = new Date();
            const diffHours = (now - date) / (1000 * 60 * 60);
            if (diffHours < 24) return 'earlier today';
            if (diffHours < 48) return 'yesterday';
            return 'this week';
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const dateDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const h = date.getHours();
            const min = date.getMinutes().toString().padStart(2, '0');
            const hour12 = h % 12 || 12;
            const ampm = h >= 12 ? 'PM' : 'AM';
            const timeStr = `${hour12}:${min} ${ampm}`;
            
            if (dateDay.getTime() === today.getTime()) {
                // Today - use morning/afternoon/evening
                if (h < 12) return `Since ${timeStr} this morning`;
                if (h < 17) return `Since ${timeStr} this afternoon`;
                return `Since ${timeStr} this evening`;
            } else if (dateDay.getTime() === yesterday.getTime()) {
                return `Since ${timeStr} yesterday`;
            } else {
                const m = date.getMonth() + 1;
                const d = date.getDate();
                return `Since ${m}/${d} ${timeStr}`;
            }
        }

        // ==========================================
        // HAMBURGER MENU
        // ==========================================
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const menuOverlay = document.getElementById('menuOverlay');
        const slideMenu = document.getElementById('slideMenu');

        function openMenu() { menuOverlay.classList.add('show'); slideMenu.classList.add('show'); }
        function closeMenu() { menuOverlay.classList.remove('show'); slideMenu.classList.remove('show'); }

        hamburgerBtn.addEventListener('click', openMenu);
        menuOverlay.addEventListener('click', closeMenu);

        document.getElementById('menuEditProfile').addEventListener('click', () => { closeMenu(); showEditProfile(); });
        document.getElementById('menuGettingStarted').addEventListener('click', () => { closeMenu(); document.getElementById('gettingStartedModal').classList.add('show'); });
        document.getElementById('menuWiki').addEventListener('click', () => { closeMenu(); document.getElementById('wikiModal').classList.add('show'); });
        document.getElementById('closeWiki').addEventListener('click', () => { document.getElementById('wikiModal').classList.remove('show'); });
        
        // Wiki topic content
        const wikiTopics = {
            cpue: {
                title: 'üìä What is ‚àöCPUE?',
                content: `<p><strong>CPUE</strong> stands for <em>Catch Per Unit Effort</em> ‚Äî a standard metric in environmental science.</p>
                    <p>In CHIMERA, we calculate it as:</p>
                    <p style="background: #f3f4f6; padding: 12px; border-radius: 8px; font-family: monospace; text-align: center;">
                        ‚àöCPUE = ‚àö(weight √∑ distance)
                    </p>
                    <p>The square root transformation normalizes the data and makes comparisons meaningful across different collection sessions.</p>
                    <p><strong>Higher ‚àöCPUE</strong> = More litter collected per distance traveled</p>`
            },
            zones: {
                title: 'üó∫Ô∏è Montgomery Zones',
                content: `<p>Montgomery is divided into geographic zones for data collection and analysis.</p>
                    <p>Zones help us:</p>
                    <ul>
                        <li>Track litter patterns by area</li>
                        <li>Coordinate cleanup events</li>
                        <li>Measure progress over time</li>
                        <li>Identify priority areas</li>
                    </ul>
                    <p>Your zone is determined automatically by GPS when you submit a session.</p>`
            },
            validation: {
                title: '‚úì Scout Validation',
                content: `<p>When you <strong>Rate a Location</strong>, your rating is stored as a prediction.</p>
                    <p>When someone later <strong>Collects</strong> in that area, we compare:</p>
                    <ul>
                        <li>Your rating (0-10 scale)</li>
                        <li>Actual ‚àöCPUE from collection</li>
                    </ul>
                    <p>The difference is your <strong>divergence score</strong>. Lower is better!</p>
                    <p><strong>Spot On:</strong> ‚â§1 divergence<br>
                    <strong>Close:</strong> ‚â§3 divergence<br>
                    <strong>Off:</strong> >3 divergence</p>`
            },
            safety: {
                title: '‚ö†Ô∏è Safety Guidelines',
                content: `<ul>
                        <li>Watch for traffic when crossing streets</li>
                        <li>Wear gloves when handling litter</li>
                        <li>Stay hydrated and take breaks</li>
                        <li>Work in pairs when possible</li>
                        <li><strong>Never operate a vehicle while tracking</strong></li>
                        <li>Stay aware of your surroundings</li>
                        <li>Avoid hazards (glass, sharp objects, wildlife)</li>
                        <li>Don't enter private property without permission</li>
                    </ul>`
            },
            privacy: {
                title: 'üîí Privacy & Data',
                content: `<p><strong>What we collect:</strong></p>
                    <ul>
                        <li>GPS coordinates during sessions</li>
                        <li>Litter ratings and collection weights</li>
                        <li>Photos (with your consent)</li>
                        <li>Your handle (not your real name)</li>
                    </ul>
                    <p><strong>What we don't share:</strong></p>
                    <ul>
                        <li>Your email (if provided)</li>
                        <li>Your exact home address</li>
                        <li>Individual GPS tracks</li>
                    </ul>
                    <p>GPS data is archived after validation and deleted after 30 days.</p>`
            }
        };
        
        function showWikiTopic(topicId) {
            const topic = wikiTopics[topicId];
            if (!topic) return;
            document.getElementById('wikiTopicTitle').textContent = topic.title;
            document.getElementById('wikiTopicContent').innerHTML = topic.content;
            document.getElementById('wikiTopicModal').classList.add('show');
        }
        
        document.getElementById('menuFieldTest').addEventListener('click', () => { window.location.href = CONFIG.urls.fieldTestMap; });
        document.getElementById('menuDemo').addEventListener('click', () => { window.location.href = CONFIG.urls.demoGame; });

        document.getElementById('menuScout').addEventListener('click', () => {
            if (sunLocked) { showToast('Unavailable after sunset', 'warning'); return; }
            closeMenu(); showScoutMode();
        });
        document.getElementById('menuPin').addEventListener('click', () => showToast('Pin Location coming soon!', 'warning'));
        document.getElementById('menuTrack').addEventListener('click', () => {
            if (sunLocked) { showToast('Unavailable after sunset', 'warning'); return; }
            closeMenu(); startCollection();
        });
        document.getElementById('menuRecycle').addEventListener('click', () => { closeMenu(); showRecycleScreen(); });
        document.getElementById('menuLogout').addEventListener('click', () => { if (confirm('Log out?')) { clearSession(); location.reload(); } });
        
        // Activity Feed menu handler
        document.getElementById('menuActivityFeed').addEventListener('click', () => { closeMenu(); showMainScreen(); });
        
        // Event Manager menu handlers
        document.getElementById('menuEventManager').addEventListener('click', () => { closeMenu(); showEventManager(); });
        document.getElementById('menuUpcomingEvents').addEventListener('click', () => { closeMenu(); showUpcomingEvents(); });

        // ===========================================
        // MODALS
        // ==========================================
        document.getElementById('closeGettingStarted').addEventListener('click', () => {
            document.getElementById('gettingStartedModal').classList.remove('show');
        });

        document.getElementById('safetyLegalAck').addEventListener('change', function() {
            document.getElementById('acceptSafetyLegal').disabled = !this.checked;
        });

        document.getElementById('acceptSafetyLegal').addEventListener('click', async () => {
            currentUser.safetyLegalAccepted = true;
            currentUser.lastSafetyLegalCheck = new Date().toISOString();
            saveSession();
            
            try {
                await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'updateProfile', userId: currentUser.userId, safetyLegalAccepted: true })
                });
            } catch (e) { console.error('Safety save error:', e); }
            
            document.getElementById('safetyLegalModal').classList.remove('show');
            showToast('Safety guidelines acknowledged', 'success');
            showMainScreen();
        });

        // ==========================================
        // ACTIVITY FEED
        // ==========================================
        async function loadActivityFeed(isLoggedIn = true) {
            const scrollId = isLoggedIn ? 'feedScroll' : 'preLoginFeedScroll';
            const feedScroll = document.getElementById(scrollId);
            
            try {
                // Fetch activity feed and banners in parallel
                const [feedResponse, bannersResponse] = await Promise.all([
                    fetch(CONFIG.appsScriptUrl + '?action=getActivityFeed'),
                    fetch(CONFIG.appsScriptUrl + '?action=get_active_banners')
                ]);
                
                const result = await feedResponse.json();
                let bannersResult = { banners: [] };
                try {
                    bannersResult = await bannersResponse.json();
                } catch (e) { /* ignore banner errors */ }
                
                if (result.status !== 'success') {
                    feedScroll.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 40px;">Failed to load</div>';
                    return;
                }

                const data = result.data;
                let html = '';

                // Banners first
                if (bannersResult.status === 'success' && bannersResult.banners && bannersResult.banners.length > 0) {
                    const bannerIcons = {
                        info: '‚ÑπÔ∏è',
                        success: 'üéâ',
                        warning: '‚ö†Ô∏è',
                        event: 'üìÖ'
                    };
                    bannersResult.banners.forEach(banner => {
                        const icon = bannerIcons[banner.bannerType] || '‚ÑπÔ∏è';
                        const type = banner.bannerType || 'info';
                        html += `<div class="feed-banner ${type}">
                            <span class="feed-banner-icon">${icon}</span>
                            <span class="feed-banner-text">${banner.message}</span>
                        </div>`;
                    });
                }

                // Sticky: Awaiting Validation
                if (data.unvalidatedScouts > 0) {
                    const sinceTime = data.oldestUnvalidated ? new Date(data.oldestUnvalidated) : new Date();
                    const timeStr = isLoggedIn ? formatRelativeTime(sinceTime) : 'Since earlier today';
                    const tpl = data.stickyTemplates || {};
                    const headerText = (tpl.unvalidated_header || '')
                        .replace('{count}', data.unvalidatedScouts)
                        .replace('{s}', data.unvalidatedScouts !== 1 ? 's' : '');
                    const detailText = (tpl.unvalidated_detail || '').replace('{time}', timeStr);
                    
                    // Only show if header is not disabled
                    if (headerText) {
                        html += `<div class="feed-sticky-item">
                            <div class="feed-sticky-header"><span>‚è≥</span> ${headerText}</div>
                            ${detailText ? `<div class="feed-sticky-detail">${detailText}</div>` : ''}
                        </div>`;
                    }
                }

                // Sticky: Daily Accuracy
                if (data.dailyAccuracy !== undefined && data.dailyAccuracy !== null) {
                    const tpl = data.stickyTemplates || {};
                    const headerText = tpl.accuracy_header || '';
                    const valueText = (tpl.accuracy_value || '').replace('{accuracy}', data.dailyAccuracy);
                    const detailText = (tpl.accuracy_detail || '')
                        .replace('{validated}', data.validatedToday || 0)
                        .replace('{total}', data.scoutsToday || 0);
                    
                    // Only show if header and value are not disabled
                    if (headerText && valueText) {
                        html += `<div class="feed-sticky-item accuracy">
                            <div class="feed-sticky-header"><span>üìä</span> ${headerText}</div>
                            <div class="accuracy-value">${valueText}</div>
                            ${detailText ? `<div class="feed-sticky-detail">${detailText}</div>` : ''}
                        </div>`;
                    }
                }

                // Collection items
                if (!data.recentActivity || data.recentActivity.length === 0) {
                    html += '<div style="text-align: center; color: #9ca3af; padding: 40px;">No recent activity</div>';
                } else {
                    data.recentActivity.forEach(activity => {
                        const time = new Date(activity.timestamp);
                        const timeStr = isLoggedIn ? formatTimeShort(time) : formatTimeVague(time);
                        const name = isLoggedIn ? activity.volunteer : 'Volunteer';
                        const zoneBadge = activity.zoneName ? `<span class="district-badge">${activity.zoneName}</span>` : '';

                        // COORDINATOR POSTS
                        if (activity.type === 'coordinator_post') {
                            html += `<div class="activity-item" style="border-left: 3px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                                <div class="activity-header">
                                    <span class="activity-icon">üì¢</span>
                                    <span class="activity-text" style="color: #92400e; font-weight: 500;">${activity.generatedText || 'Event update'}</span>
                                </div>
                                <div style="font-size: 11px; color: #b45309; margin-top: 4px;">${timeStr}</div>
                            </div>`;
                            return;
                        }

                        // Skip scouts - they only appear when validated via collections
                        if (activity.type === 'scout') return;

                        // COLLECTIONS (original code)
                        if (activity.type !== 'collection') return;

                        html += `<div class="activity-item">
                            <div class="activity-header">
                                <span class="activity-icon">üóëÔ∏è</span>
                                <span class="activity-text">${name} collected ${activity.weight.toFixed(1)} lbs${activity.sqrtCpue ? ` (‚àöCPUE: ${activity.sqrtCpue.toFixed(2)})` : ''} ${timeStr}</span>
                                ${zoneBadge}
                            </div>`;

                        // Validation box
                        const val = activity.validation || { accurate: [], close: [], off: [] };
                        const totalValidated = val.accurate.length + val.close.length + val.off.length;

                        if (totalValidated > 0) {
                            html += `<div class="validation-box">
                                <div class="validation-header">üëÄ SCOUT RATINGS VALIDATED</div>`;
                            
                            if (isLoggedIn) {
                                if (val.accurate.length > 0) html += `<div class="validation-line spot-on"><strong>Spot on:</strong> ${val.accurate.join(', ')}</div>`;
                                if (val.close.length > 0) html += `<div class="validation-line under"><strong>Under:</strong> ${val.close.join(', ')}</div>`;
                                if (val.off.length > 0) html += `<div class="validation-line over"><strong>Over:</strong> ${val.off.join(', ')}</div>`;
                            } else {
                                const parts = [];
                                if (val.accurate.length > 0) parts.push(`${val.accurate.length} spot on`);
                                if (val.close.length > 0) parts.push(`${val.close.length} under`);
                                if (val.off.length > 0) parts.push(`${val.off.length} over`);
                                html += `<div class="validation-line">${parts.join(', ')}</div>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="no-validation">No scouts validated</div>`;
                        }

                        html += `</div>`;
                    });
                }

                feedScroll.innerHTML = html;
            } catch (error) {
                console.error('Activity feed error:', error);
                feedScroll.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 40px;">Failed to load</div>';
            }
        }

        // ==========================================
        // SUN CHECK
        // ==========================================
        async function checkSunSchedule() {
            // Check for sun_override first
            if (currentUser && currentUser.overrides && currentUser.overrides.includes('sun_override')) {
                sunLocked = false;
                return;
            }

            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=sun_check');
                const result = await response.json();
                
                if (result.status === 'success') {
                    sunLocked = result.locked;
                    if (sunLocked) {
                        document.getElementById('menuLockoutBanner').classList.add('show');
                        document.getElementById('menuLockoutSunrise').textContent = result.tomorrowSunrise || '--:--';
                        document.getElementById('menuScout').classList.add('disabled');
                        document.getElementById('menuTrack').classList.add('disabled');
                    }
                }
            } catch (error) { console.error('Sun check error:', error); }
        }

        // ==========================================
        // LOGIN / CREATE PROFILE
        // ==========================================
        const loginHandle = document.getElementById('loginHandle');
        const loginPIN = document.getElementById('loginPIN');
        const loginBtn = document.getElementById('loginBtn');
        const createHandle = document.getElementById('createHandle');
        const createPIN = document.getElementById('createPIN');
        const createOrgSelect = document.getElementById('createOrgSelect');
        const createCustomOrgText = document.getElementById('createCustomOrgText');
        const createProfileBtn = document.getElementById('createProfileBtn');

        document.getElementById('showCreateToggle').addEventListener('click', () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('createForm').classList.remove('hidden');
        });
        document.getElementById('showLoginToggle').addEventListener('click', () => {
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        });

        const PIN_REGEX = /^[a-zA-Z]{2}[0-9]{2}$/;

        loginHandle.addEventListener('input', validateLogin);
        loginPIN.addEventListener('input', validateLogin);
        function validateLogin() {
            loginBtn.disabled = !(loginHandle.value.trim().length >= 2 && PIN_REGEX.test(loginPIN.value.trim()));
        }

        createHandle.addEventListener('input', validateCreate);
        createPIN.addEventListener('input', validateCreate);
        createOrgSelect.addEventListener('change', function() {
            document.getElementById('createCustomOrg').classList.toggle('show', this.value === 'other');
            validateCreate();
        });
        createCustomOrgText.addEventListener('input', validateCreate);

        function validateCreate() {
            const handleOk = createHandle.value.trim().length >= 2;
            const pinOk = PIN_REGEX.test(createPIN.value.trim());
            const orgOk = createOrgSelect.value !== '' && (createOrgSelect.value !== 'other' || createCustomOrgText.value.trim() !== '');
            createProfileBtn.disabled = !(handleOk && pinOk && orgOk);
        }

        loginBtn.addEventListener('click', async function() {
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'login', handle: loginHandle.value.trim(), pin: loginPIN.value.trim().toLowerCase() })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser = {
                        userId: result.userId, handle: result.handle, organization: result.organization,
                        addresses: result.addresses || [],
                        safetyLegalAccepted: result.safetyLegalAccepted || false,
                        lastSafetyLegalCheck: result.lastSafetyLegalCheck || null,
                        overrides: result.overrides || []
                    };
                    saveSession();
                    enterApp();
                } else {
                    showToast(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Connection error', 'error');
            }

            loginBtn.disabled = false;
            loginBtn.textContent = 'Log In';
        });

        createProfileBtn.addEventListener('click', async function() {
            createProfileBtn.disabled = true;
            createProfileBtn.textContent = 'Creating...';

            const org = createOrgSelect.value === 'other' ? createCustomOrgText.value.trim() : createOrgSelect.value;

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'createProfile', handle: createHandle.value.trim(), pin: createPIN.value.trim().toLowerCase(), organization: org })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser = {
                        userId: result.userId, handle: result.handle, organization: org,
                        addresses: [], safetyLegalAccepted: false, lastSafetyLegalCheck: null,
                        overrides: []
                    };
                    saveSession();
                    showToast('Profile created!', 'success');
                    enterApp();
                } else {
                    showToast(result.message || 'Creation failed', 'error');
                }
            } catch (error) {
                console.error('Create error:', error);
                showToast('Connection error', 'error');
            }

            createProfileBtn.disabled = false;
            createProfileBtn.textContent = 'Create Profile';
        });

        // ==========================================
        // APP ENTRY
        // ==========================================
        function enterApp() {
            const needsCheck = !currentUser.safetyLegalAccepted || !currentUser.lastSafetyLegalCheck ||
                              (new Date() - new Date(currentUser.lastSafetyLegalCheck)) > 7 * 24 * 60 * 60 * 1000;
            
            if (needsCheck) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('safetyLegalModal').classList.add('show');
            } else {
                showMainScreen();
            }
        }

        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('menuUsername').textContent = currentUser.handle;
            document.getElementById('hamburgerBtn').classList.remove('hidden');
            
            loadActivityFeed(true);
            loadUpcomingBanner();
            checkSunSchedule();
            checkCoordinatorStatus();
            checkNotifications();
            
            // Hunt Integration: Check query params and redirect if needed
            const urlParams = new URLSearchParams(window.location.search);
            const fromHunt = urlParams.get('from') === 'hunt';
            const action = urlParams.get('action');
            
            if (fromHunt) {
                huntIntegration.fromHunt = true;
                huntIntegration.action = action;
                
                // Clear query params from URL without reload
                window.history.replaceState({}, document.title, window.location.pathname);
                
                if (action === 'scout') {
                    showScoutMode();
                } else if (action === 'collect') {
                    startCollection();
                }
                // If no action, just show normal CHIMERA
            }
        }
        
        // Notification badge management
        async function checkNotifications() {
            let count = 0;
            
            // For coordinators: check for status changes on their events
            if (checkCoordinatorStatus()) {
                try {
                    const response = await fetch(CONFIG.appsScriptUrl + '?action=get_my_events&userId=' + currentUser.userId);
                    const result = await response.json();
                    if (result.status === 'success' && result.events) {
                        // Count recently reviewed events (approved/rejected in last 24h could be a notification)
                        // For now, just count events that need attention
                        const needsAttention = result.events.filter(e => e.status === 'approved' && !e.reviewNotes);
                        // This is a simple placeholder - could be enhanced
                    }
                } catch (e) {}
            }
            
            // Check for upcoming events in next 24 hours
            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_upcoming_events');
                const result = await response.json();
                if (result.status === 'success' && result.events) {
                    const now = new Date();
                    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    const soonEvents = result.events.filter(e => {
                        const eventDate = new Date(e.eventDate);
                        return eventDate >= now && eventDate <= tomorrow;
                    });
                    count += soonEvents.length;
                }
            } catch (e) {}
            
            updateNotificationBadge(count);
        }
        
        function updateNotificationBadge(count) {
            const badge = document.getElementById('hamburgerBadge');
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==========================================
        // SCOUT MODE (Single Capture)
        // ==========================================
        function showScoutMode() {
            hideAllScreens();
            document.getElementById('scoutScreen').classList.remove('hidden');
            
            // Reset
            sessionState = { sessionId: 'scout_' + Date.now(), gpsPoints: [], ratingTouched: false, mode: 'scout-only' };
            document.getElementById('scoutRatingSlider').value = 5;
            document.getElementById('scoutRatingSlider').classList.add('untouched');
            document.getElementById('scoutRatingValue').textContent = '‚Äî';
            document.getElementById('scoutRatingValue').classList.add('untouched');
            document.getElementById('scoutRatingDesc').textContent = 'Tap the slider to rate';
            document.getElementById('scoutNotes').value = '';
            document.getElementById('scoutNotesCount').textContent = '0';
            document.getElementById('scoutGPSStatus').textContent = 'Capturing...';
            document.getElementById('scoutGPSStatus').style.color = '#1f2937';
            document.querySelectorAll('input[name="scoutFeed"]').forEach(r => r.checked = false);
            document.getElementById('submitScoutBtn').disabled = true;

            // Capture GPS once
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        sessionState.gpsPoints = [{ lat: pos.coords.latitude, lon: pos.coords.longitude, timestamp: new Date().toISOString() }];
                        document.getElementById('scoutGPSStatus').textContent = 'Captured ‚úì';
                        document.getElementById('scoutGPSStatus').style.color = '#10b981';
                    },
                    (err) => {
                        console.error('GPS error:', err);
                        document.getElementById('scoutGPSStatus').textContent = 'Error';
                        document.getElementById('scoutGPSStatus').style.color = '#dc2626';
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        document.getElementById('scoutRatingSlider').addEventListener('input', function() {
            sessionState.ratingTouched = true;
            this.classList.remove('untouched');
            document.getElementById('scoutRatingValue').textContent = this.value;
            document.getElementById('scoutRatingValue').classList.remove('untouched');
            document.getElementById('scoutRatingDesc').textContent = ratingDescriptions[this.value];
            validateScoutSubmit();
        });

        document.getElementById('scoutNotes').addEventListener('input', function() {
            document.getElementById('scoutNotesCount').textContent = this.value.length;
        });

        document.querySelectorAll('input[name="scoutFeed"]').forEach(r => r.addEventListener('change', validateScoutSubmit));

        function validateScoutSubmit() {
            const consentOk = document.querySelector('input[name="scoutFeed"]:checked');
            document.getElementById('submitScoutBtn').disabled = !consentOk;
        }

        document.getElementById('submitScoutBtn').addEventListener('click', async function() {
            if (sessionState.gpsPoints.length === 0) { showToast('No GPS captured', 'error'); return; }

            this.disabled = true;
            this.textContent = 'Submitting...';

            const rating = sessionState.ratingTouched ? parseInt(document.getElementById('scoutRatingSlider').value) : null;

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'submitSession', mode: 'scout-only', sessionId: sessionState.sessionId,
                        userId: currentUser.userId, volunteerName: currentUser.handle, organization: currentUser.organization,
                        gpsPoints: sessionState.gpsPoints,
                        startLat: sessionState.gpsPoints[0].lat, startLon: sessionState.gpsPoints[0].lon,
                        endLat: sessionState.gpsPoints[0].lat, endLon: sessionState.gpsPoints[0].lon,
                        rating: rating, notes: document.getElementById('scoutNotes').value.trim(),
                        activityFeedConsent: document.querySelector('input[name="scoutFeed"]:checked').value === 'yes',
                        timestamp: new Date().toISOString()
                    })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showToast('Scout submitted!', 'success');
                    
                    // Hunt Integration: Redirect back to Hunt if came from there
                    if (huntIntegration.fromHunt) {
                        setTimeout(() => {
                            window.location.href = 'chimera-hunt.html?completed=scout&sessionId=' + sessionState.sessionId;
                        }, 1500);
                    } else {
                        setTimeout(() => showMainScreen(), 1500);
                    }
                } else {
                    showToast(result.message || 'Submission failed', 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showToast('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Submit Scout Report';
        });

        document.getElementById('cancelScoutBtn').addEventListener('click', () => {
            if (confirm('Cancel scout?')) showMainScreen();
        });

        // ==========================================
        // COLLECTION TRACKING
        // ==========================================
        function startCollection() {
            hideAllScreens();
            document.getElementById('activeTrackingScreen').classList.remove('hidden');

            sessionState = {
                sessionId: 'collection_' + Date.now(), isTracking: true, startTime: Date.now(),
                gpsPoints: [], photos: [], totalDistance: 0, mode: 'collection', ratingTouched: false
            };

            // Start GPS tracking
            captureGPSPoint();
            sessionState.gpsTimer = setInterval(captureGPSPoint, CONFIG.gpsInterval);
            sessionState.durationTimer = setInterval(updateTrackingDisplay, 1000);

            showToast('Tracking started!', 'success');
        }

        function captureGPSPoint() {
            if (!navigator.geolocation || !sessionState.isTracking) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const point = { lat: pos.coords.latitude, lon: pos.coords.longitude, timestamp: new Date().toISOString() };
                    if (sessionState.gpsPoints.length > 0) {
                        const last = sessionState.gpsPoints[sessionState.gpsPoints.length - 1];
                        sessionState.totalDistance += calculateDistance(last.lat, last.lon, point.lat, point.lon);
                    }
                    sessionState.gpsPoints.push(point);
                    document.getElementById('trackingDistance').textContent = sessionState.totalDistance.toFixed(2) + ' mi';
                },
                (err) => console.error('GPS error:', err),
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function updateTrackingDisplay() {
            if (!sessionState.isTracking) return;
            const elapsed = Math.floor((Date.now() - sessionState.startTime) / 1000);
            document.getElementById('trackingDuration').textContent = formatDuration(elapsed);
        }

        document.getElementById('trackingPhotoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            navigator.geolocation.getCurrentPosition((pos) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    sessionState.photos.push({ timestamp: new Date().toISOString(), lat: pos.coords.latitude, lon: pos.coords.longitude, data: event.target.result });
                    document.getElementById('trackingPhotoCount').textContent = sessionState.photos.length + ' photo' + (sessionState.photos.length !== 1 ? 's' : '') + ' captured';
                    showToast('Photo captured!', 'success');
                };
                reader.readAsDataURL(file);
            });
            this.value = '';
        });

        document.getElementById('stopTrackingBtn').addEventListener('click', function() {
            sessionState.isTracking = false;
            clearInterval(sessionState.gpsTimer);
            clearInterval(sessionState.durationTimer);
            captureGPSPoint();
            showPostTrackingScreen();
        });

        function showPostTrackingScreen() {
            hideAllScreens();
            document.getElementById('postTrackingScreen').classList.remove('hidden');

            const totalSeconds = Math.floor((Date.now() - sessionState.startTime) / 1000);
            document.getElementById('finalDuration').textContent = formatDuration(totalSeconds);
            document.getElementById('finalDistance').textContent = sessionState.totalDistance.toFixed(2) + ' mi';

            // Reset form
            document.getElementById('postRatingSlider').value = 5;
            document.getElementById('postRatingSlider').classList.add('untouched');
            document.getElementById('postRatingValue').textContent = '‚Äî';
            document.getElementById('postRatingValue').classList.add('untouched');
            document.getElementById('postRatingDesc').textContent = 'Tap the slider to rate';
            document.getElementById('postNotes').value = '';
            document.getElementById('postNotesCount').textContent = '0';
            document.getElementById('bagsContainer').innerHTML = '';
            bags = []; bagCounter = 0;
            addBag(); // Start with one bag

            document.querySelectorAll('input[name="postFeed"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="photoConsent"]').forEach(r => r.checked = false);
            
            if (sessionState.photos.length > 0) {
                document.getElementById('photoConsentQuestion').classList.remove('hidden');
            } else {
                document.getElementById('photoConsentQuestion').classList.add('hidden');
            }

            document.getElementById('submitCollectionBtn').disabled = true;
        }

        document.getElementById('postRatingSlider').addEventListener('input', function() {
            sessionState.ratingTouched = true;
            this.classList.remove('untouched');
            document.getElementById('postRatingValue').textContent = this.value;
            document.getElementById('postRatingValue').classList.remove('untouched');
            document.getElementById('postRatingDesc').textContent = ratingDescriptions[this.value];
        });

        document.getElementById('postNotes').addEventListener('input', function() {
            document.getElementById('postNotesCount').textContent = this.value.length;
        });

        // Bag management
        function addBag() {
            bagCounter++;
            const bagId = 'bag_' + bagCounter;
            bags.push(bagId);
            const bagDiv = document.createElement('div');
            bagDiv.className = 'bag-entry';
            bagDiv.id = bagId;
            bagDiv.innerHTML = `
                <div class="bag-header">
                    <span class="bag-number">Bag ${bagCounter}</span>
                    <span class="remove-bag" onclick="removeBag('${bagId}')">Remove</span>
                </div>
                <input type="number" class="form-input" placeholder="Weight (lbs)" step="0.1" min="0">
            `;
            document.getElementById('bagsContainer').appendChild(bagDiv);
        }

        window.removeBag = function(bagId) {
            document.getElementById(bagId)?.remove();
            bags = bags.filter(id => id !== bagId);
        };

        document.getElementById('addBagBtn').addEventListener('click', addBag);

        document.querySelectorAll('input[name="postFeed"]').forEach(r => r.addEventListener('change', validateCollectionSubmit));
        document.querySelectorAll('input[name="photoConsent"]').forEach(r => r.addEventListener('change', validateCollectionSubmit));

        function validateCollectionSubmit() {
            const feedOk = document.querySelector('input[name="postFeed"]:checked');
            const photoOk = sessionState.photos.length === 0 || document.querySelector('input[name="photoConsent"]:checked');
            document.getElementById('submitCollectionBtn').disabled = !(feedOk && photoOk);
        }

        document.getElementById('submitCollectionBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Submitting...';

            const bagWeights = [];
            document.querySelectorAll('#bagsContainer .form-input').forEach(input => {
                const w = parseFloat(input.value) || 0;
                if (w > 0) bagWeights.push(w);
            });
            const totalWeight = bagWeights.reduce((sum, w) => sum + w, 0);

            if (totalWeight === 0) {
                showToast('Enter at least one bag weight', 'error');
                this.disabled = false;
                this.textContent = 'Submit Report';
                return;
            }

            const rating = sessionState.ratingTouched ? parseInt(document.getElementById('postRatingSlider').value) : null;
            const duration = Math.floor((Date.now() - sessionState.startTime) / 1000);

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'submitSession', mode: 'collection', sessionId: sessionState.sessionId,
                        userId: currentUser.userId, volunteerName: currentUser.handle, organization: currentUser.organization,
                        gpsPoints: sessionState.gpsPoints,
                        startLat: sessionState.gpsPoints[0]?.lat, startLon: sessionState.gpsPoints[0]?.lon,
                        endLat: sessionState.gpsPoints[sessionState.gpsPoints.length - 1]?.lat,
                        endLon: sessionState.gpsPoints[sessionState.gpsPoints.length - 1]?.lon,
                        rating: rating, notes: document.getElementById('postNotes').value.trim(),
                        weight: totalWeight, bagCount: bagWeights.length,
                        duration: duration, distance: sessionState.totalDistance,
                        photoCount: sessionState.photos.length,
                        activityFeedConsent: document.querySelector('input[name="postFeed"]:checked').value === 'yes',
                        photoConsent: sessionState.photos.length > 0 && document.querySelector('input[name="photoConsent"]:checked')?.value === 'yes',
                        timestamp: new Date().toISOString()
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Collection submitted!', 'success');
                    
                    // Hunt Integration: Redirect back to Hunt if came from there
                    if (huntIntegration.fromHunt) {
                        setTimeout(() => {
                            window.location.href = 'chimera-hunt.html?completed=collection&sessionId=' + sessionState.sessionId;
                        }, 1500);
                    } else {
                        setTimeout(() => showMainScreen(), 1500);
                    }
                } else {
                    showToast(result.message || 'Submission failed', 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showToast('Connection error', 'error');
            }

            this.disabled = false;
            this.textContent = 'Submit Report';
        });

        document.getElementById('cancelCollectionBtn').addEventListener('click', () => {
            if (confirm('Discard collection data?')) showMainScreen();
        });

        // ==========================================
        // EDIT PROFILE
        // ==========================================
        function showEditProfile() {
            hideAllScreens();
            document.getElementById('editProfileScreen').classList.remove('hidden');

            document.getElementById('editHandle').value = currentUser.handle;
            
            const orgSelect = document.getElementById('editOrgSelect');
            if (CONFIG.organizations.includes(currentUser.organization)) {
                orgSelect.value = currentUser.organization;
                document.getElementById('editCustomOrg').classList.remove('show');
            } else {
                orgSelect.value = 'other';
                document.getElementById('editCustomOrg').classList.add('show');
                document.getElementById('editCustomOrgText').value = currentUser.organization;
            }

            renderAddresses();
        }

        document.getElementById('editOrgSelect').addEventListener('change', function() {
            document.getElementById('editCustomOrg').classList.toggle('show', this.value === 'other');
        });

        function renderAddresses() {
            const container = document.getElementById('addressesContainer');
            container.innerHTML = '';
            
            if (!currentUser.addresses || currentUser.addresses.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">No addresses saved</div>';
                return;
            }

            currentUser.addresses.forEach((addr, index) => {
                const card = document.createElement('div');
                card.className = 'address-card';
                card.innerHTML = `
                    <div class="address-card-header">
                        <span class="address-type-badge">${addr.type || 'Home'}</span>
                        <div class="address-actions">
                            <span class="address-action" onclick="editAddress(${index})">Edit</span>
                            <span class="address-action delete" onclick="deleteAddress(${index})">Delete</span>
                        </div>
                    </div>
                    <div class="address-text">
                        ${addr.street || ''}${addr.street && addr.neighborhood ? ', ' : ''}${addr.neighborhood || ''}${(addr.street || addr.neighborhood) && addr.zip ? ' ' : ''}${addr.zip || ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        document.getElementById('addAddressBtn').addEventListener('click', () => {
            document.getElementById('newAddressType').value = 'Home';
            document.getElementById('newAddressStreet').value = '';
            document.getElementById('newAddressNeighborhood').value = '';
            document.getElementById('newAddressZip').value = '';
            document.getElementById('addAddressModal').classList.add('show');
        });

        document.getElementById('cancelNewAddress').addEventListener('click', () => {
            document.getElementById('addAddressModal').classList.remove('show');
        });

        document.getElementById('saveNewAddress').addEventListener('click', () => {
            const newAddr = {
                type: document.getElementById('newAddressType').value,
                street: document.getElementById('newAddressStreet').value.trim(),
                neighborhood: document.getElementById('newAddressNeighborhood').value.trim(),
                zip: document.getElementById('newAddressZip').value.trim()
            };
            
            if (!newAddr.street && !newAddr.neighborhood && !newAddr.zip) {
                showToast('Enter at least one field', 'error');
                return;
            }

            if (!currentUser.addresses) currentUser.addresses = [];
            currentUser.addresses.push(newAddr);
            renderAddresses();
            document.getElementById('addAddressModal').classList.remove('show');
            showToast('Address added', 'success');
        });

        window.editAddress = function(index) {
            const addr = currentUser.addresses[index];
            document.getElementById('newAddressType').value = addr.type || 'Home';
            document.getElementById('newAddressStreet').value = addr.street || '';
            document.getElementById('newAddressNeighborhood').value = addr.neighborhood || '';
            document.getElementById('newAddressZip').value = addr.zip || '';
            
            // Remove old, save will add new
            currentUser.addresses.splice(index, 1);
            renderAddresses();
            document.getElementById('addAddressModal').classList.add('show');
        };

        window.deleteAddress = function(index) {
            if (confirm('Delete this address?')) {
                currentUser.addresses.splice(index, 1);
                renderAddresses();
            }
        };

        document.getElementById('saveProfileBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Saving...';

            const org = document.getElementById('editOrgSelect').value === 'other'
                ? document.getElementById('editCustomOrgText').value.trim()
                : document.getElementById('editOrgSelect').value;

            try {
                await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateProfile', userId: currentUser.userId,
                        organization: org, addresses: currentUser.addresses
                    })
                });

                currentUser.organization = org;
                saveSession();
                showToast('Profile updated!', 'success');
                setTimeout(() => showMainScreen(), 1000);
            } catch (error) {
                console.error('Profile update error:', error);
                showToast('Update failed', 'error');
            }

            this.disabled = false;
            this.textContent = 'Save Changes';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => showMainScreen());

        // ==========================================
        // HOUSEHOLD RECYCLING
        // ==========================================
        function showRecycleScreen() {
            hideAllScreens();
            document.getElementById('recycleScreen').classList.remove('hidden');
            resetRecycleForm();
        }

        function resetRecycleForm() {
            document.getElementById('hrMaterialType').value = '';
            document.getElementById('hrDescription').value = '';
            document.getElementById('hrDescriptionWrap').classList.add('hidden');
            document.getElementById('hrWeight').value = '';
            document.getElementById('hrDateBagged').value = '';
            document.getElementById('hrDestination').value = '';
            document.getElementById('hrDestOther').value = '';
            document.getElementById('hrDestOtherWrap').classList.remove('show');
            document.getElementById('submitHRBtn').disabled = true;
        }

        document.getElementById('hrInfoToggle').addEventListener('click', () => {
            document.getElementById('hrInfoPane').classList.toggle('show');
        });
        document.getElementById('dropoffToggle').addEventListener('click', () => {
            document.getElementById('dropoffPane').classList.toggle('show');
        });

        document.getElementById('hrMaterialType').addEventListener('change', function() {
            const needsDesc = this.value === 'Mixed' || this.value === 'Other';
            document.getElementById('hrDescriptionWrap').classList.toggle('hidden', !needsDesc);
            if (!needsDesc) document.getElementById('hrDescription').value = '';
            validateRecycleForm();
        });

        document.getElementById('hrDestination').addEventListener('change', function() {
            document.getElementById('hrDestOtherWrap').classList.toggle('show', this.value === 'Other');
            validateRecycleForm();
        });

        ['hrMaterialType', 'hrDescription', 'hrWeight', 'hrDateBagged', 'hrDestination', 'hrDestOther'].forEach(id => {
            document.getElementById(id).addEventListener('input', validateRecycleForm);
            document.getElementById(id).addEventListener('change', validateRecycleForm);
        });

        function validateRecycleForm() {
            const material = document.getElementById('hrMaterialType').value;
            const needsDesc = material === 'Mixed' || material === 'Other';
            const descOk = !needsDesc || document.getElementById('hrDescription').value.trim() !== '';
            const weightOk = parseFloat(document.getElementById('hrWeight').value) > 0;
            const dateOk = document.getElementById('hrDateBagged').value !== '';
            const destOk = document.getElementById('hrDestination').value !== '';
            document.getElementById('submitHRBtn').disabled = !(material && descOk && weightOk && dateOk && destOk);
        }

        document.getElementById('submitHRBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Submitting...';

            const material = document.getElementById('hrMaterialType').value;
            let materialDesc = material;
            if (material === 'Mixed' || material === 'Other') {
                materialDesc += ': ' + document.getElementById('hrDescription').value.trim();
            }

            try {
                await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'submitHousehold', userId: currentUser.userId,
                        materialType: materialDesc,
                        weightLbs: parseFloat(document.getElementById('hrWeight').value),
                        dateBagged: document.getElementById('hrDateBagged').value,
                        destination: document.getElementById('hrDestination').value,
                        destinationOther: document.getElementById('hrDestOther').value.trim()
                    })
                });

                showToast('Recycling logged!', 'success');
                setTimeout(() => showMainScreen(), 1500);
            } catch (error) {
                console.error('HR submit error:', error);
                showToast('Submission failed', 'error');
            }

            this.disabled = false;
            this.textContent = 'Submit Recycling Log';
        });

        document.getElementById('cancelHRBtn').addEventListener('click', () => showMainScreen());

        // ==========================================
        // PAGE LOAD
        // ==========================================
        async function checkSitePause() {
            // Users with bypass override skip this check
            if (currentUser && currentUser.overrides && currentUser.overrides.includes('site_pause_bypass')) {
                return false;
            }

            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_site_status');
                const result = await response.json();
                
                if (result.status === 'success' && result.site_status === 'paused') {
                    document.getElementById('sitePauseMessage').textContent = result.message || "We'll be back soon.";
                    document.getElementById('sitePauseOverlay').classList.add('show');
                    return true;
                }
            } catch (error) {
                console.error('Site status check error:', error);
            }
            return false;
        }

        window.addEventListener('load', async function() {
            loadActivityFeed(false); // Pre-login feed

            // Check site pause first (before login for everyone)
            const isPaused = await checkSitePause();
            if (isPaused) return; // Don't proceed if site is paused
            
            if (restoreSession() && currentUser.userId) {
                // Re-check with user overrides
                const stillPaused = await checkSitePause();
                if (!stillPaused) {
                    enterApp();
                }
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });

        // Auto-refresh feed
        setInterval(() => {
            if (!document.getElementById('mainScreen').classList.contains('hidden')) {
                loadActivityFeed(true);
            }
        }, 60000);

        // ==========================================
        // COORDINATOR EVENTS SYSTEM
        // ==========================================
        
        let currentEventData = null; // Store currently viewed event
        
        function checkCoordinatorStatus() {
            // Check if user has event_coordinator in overrides
            if (currentUser && currentUser.overrides && Array.isArray(currentUser.overrides)) {
                if (currentUser.overrides.includes('event_coordinator')) {
                    document.getElementById('coordinatorMenuSection').style.display = 'block';
                    document.getElementById('coordinatorDivider').style.display = 'block';
                    return true;
                }
            }
            document.getElementById('coordinatorMenuSection').style.display = 'none';
            document.getElementById('coordinatorDivider').style.display = 'none';
            return false;
        }

        function showEventManager() {
            hideAllScreens();
            document.getElementById('eventManagerScreen').classList.remove('hidden');
            loadMyEvents();
        }

        async function loadMyEvents() {
            const list = document.getElementById('myEventsList');
            list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px;">Loading...</div>';

            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_my_events&userId=' + currentUser.userId);
                const result = await response.json();

                if (result.status !== 'success') {
                    list.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 30px;">Failed to load events</div>';
                    return;
                }

                const events = result.events || [];

                if (events.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px;">No events yet. Create one!</div>';
                    return;
                }

                let html = '';
                events.forEach(event => {
                    const dateStr = event.eventDate ? new Date(event.eventDate).toLocaleDateString() : 'TBD';
                    const statusColors = {
                        'pending': '#f59e0b',
                        'approved': '#22c55e',
                        'rejected': '#dc2626',
                        'cancelled': '#6b7280'
                    };
                    const statusColor = statusColors[event.status] || '#6b7280';

                    html += `<div onclick="showEventDetail('${event.eventId}')" style="background: white; border-radius: 12px; padding: 14px; margin-bottom: 10px; border-left: 4px solid ${statusColor}; cursor: pointer; transition: transform 0.1s;" onmouseover="this.style.transform='scale(1.01)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-weight: 600; color: #1f2937;">${event.title}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                            üìÖ ${dateStr} &nbsp;‚Ä¢&nbsp; üìç ${event.locationName || 'TBD'}
                        </div>
                        <div style="margin-top: 8px;">
                            <span style="font-size: 11px; background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase;">
                                ${event.status}
                            </span>
                        </div>
                    </div>`;
                });

                list.innerHTML = html;

            } catch (error) {
                console.error('Load my events error:', error);
                list.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 30px;">Error loading events</div>';
            }
        }

        async function showEventDetail(eventId) {
            // Fetch event details
            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_my_events&userId=' + currentUser.userId);
                const result = await response.json();
                
                if (result.status !== 'success') {
                    showToast('Failed to load event', 'error');
                    return;
                }
                
                const event = (result.events || []).find(e => e.eventId === eventId);
                if (!event) {
                    showToast('Event not found', 'error');
                    return;
                }
                
                currentEventData = event;
                
                hideAllScreens();
                document.getElementById('eventDetailScreen').classList.remove('hidden');
                
                // Populate details
                document.getElementById('eventDetailTitle').textContent = event.title;
                
                const statusColors = { 'pending': '#f59e0b', 'approved': '#22c55e', 'rejected': '#dc2626', 'cancelled': '#6b7280' };
                const statusColor = statusColors[event.status] || '#6b7280';
                document.getElementById('eventDetailStatus').innerHTML = `Status: <span style="color: ${statusColor}; font-weight: 600; text-transform: uppercase;">${event.status}</span>`;
                
                document.getElementById('eventDetailDate').textContent = event.eventDate ? new Date(event.eventDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'TBD';
                document.getElementById('eventDetailTime').textContent = event.startTime ? `${formatTime12Hour(event.startTime)}${event.endTime ? ' - ' + formatTime12Hour(event.endTime) : ''}` : 'TBD';
                document.getElementById('eventDetailLocation').textContent = event.locationName || 'TBD';
                
                if (event.description) {
                    document.getElementById('eventDetailDescription').style.display = 'block';
                    document.getElementById('eventDetailDescText').textContent = event.description;
                } else {
                    document.getElementById('eventDetailDescription').style.display = 'none';
                }
                
                // Show/hide sections based on status
                const isApproved = event.status === 'approved';
                const canCancel = event.status === 'pending' || event.status === 'approved';
                
                document.getElementById('postUpdateSection').style.display = isApproved ? 'block' : 'none';
                document.getElementById('suppliesSection').style.display = isApproved ? 'block' : 'none';
                document.getElementById('cancelEventBtn').style.display = canCancel ? 'inline-block' : 'none';
                
                if (isApproved) {
                    loadSupplies(eventId);
                }
                
            } catch (error) {
                console.error('Show event detail error:', error);
                showToast('Error loading event', 'error');
            }
        }

        function showProposeEventScreen() {
            hideAllScreens();
            document.getElementById('proposeEventScreen').classList.remove('hidden');
            
            // Reset form
            document.getElementById('eventTitleInput').value = '';
            document.getElementById('eventDateInput').value = '';
            document.getElementById('eventStartTimeInput').value = '';
            document.getElementById('eventEndTimeInput').value = '';
            document.getElementById('eventLocationInput').value = '';
            document.getElementById('eventAddressInput').value = '';
            document.getElementById('eventDescriptionInput').value = '';
            document.getElementById('eventContactName').value = '';
            document.getElementById('eventContactPhone').value = '';
            document.getElementById('eventContactEmail').value = '';
        }

        document.getElementById('proposeEventBtn').addEventListener('click', showProposeEventScreen);
        document.getElementById('cancelEventProposalBtn').addEventListener('click', showEventManager);
        document.getElementById('backFromEventManagerBtn').addEventListener('click', showMainScreen);
        document.getElementById('backFromEventDetailBtn').addEventListener('click', showEventManager);
        document.getElementById('backFromUpcomingBtn').addEventListener('click', showMainScreen);

        // Event org dropdown handler
        document.getElementById('eventOrgSelect').addEventListener('change', function() {
            const customOrg = document.getElementById('eventCustomOrg');
            if (this.value === 'other') {
                customOrg.classList.remove('hidden');
            } else {
                customOrg.classList.add('hidden');
            }
        });

        document.getElementById('submitEventProposalBtn').addEventListener('click', async () => {
            const title = document.getElementById('eventTitleInput').value.trim();
            const orgSelect = document.getElementById('eventOrgSelect').value;
            const customOrgText = document.getElementById('eventCustomOrgText').value.trim();
            const organization = orgSelect === 'other' ? customOrgText : orgSelect;
            const eventDate = document.getElementById('eventDateInput').value;
            const startTime = document.getElementById('eventStartTimeInput').value;
            const endTime = document.getElementById('eventEndTimeInput').value;
            const locationName = document.getElementById('eventLocationInput').value.trim();
            const locationAddress = document.getElementById('eventAddressInput').value.trim();
            const description = document.getElementById('eventDescriptionInput').value.trim();
            const contactName = document.getElementById('eventContactName').value.trim();
            const contactPhone = document.getElementById('eventContactPhone').value.trim();
            const contactEmail = document.getElementById('eventContactEmail').value.trim();

            if (!title) { showToast('Event title required', 'error'); return; }
            if (!organization) { showToast('Organization required', 'error'); return; }
            if (!eventDate) { showToast('Event date required', 'error'); return; }
            if (!locationName) { showToast('Location required', 'error'); return; }

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'proposeEvent',
                        userId: currentUser.userId,
                        coordinatorName: currentUser.handle,
                        organization,
                        title,
                        eventDate,
                        startTime,
                        endTime,
                        locationName,
                        locationAddress,
                        description,
                        contactName,
                        contactPhone,
                        contactEmail
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Event submitted for approval!', 'success');
                    showEventManager();
                } else {
                    showToast(result.message || 'Submission failed', 'error');
                }
            } catch (error) {
                showToast('Submission error', 'error');
            }
        });

        // Post event update
        document.getElementById('postEventUpdateBtn').addEventListener('click', async () => {
            if (!currentEventData) return;
            
            const message = document.getElementById('eventUpdateText').value.trim();
            if (!message) { showToast('Enter a message', 'error'); return; }

            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'postEventUpdate',
                        userId: currentUser.userId,
                        eventId: currentEventData.eventId,
                        message: message
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Update posted!', 'success');
                    document.getElementById('eventUpdateText').value = '';
                } else {
                    showToast(result.message || 'Post failed', 'error');
                }
            } catch (error) {
                showToast('Post error', 'error');
            }
        });

        // Cancel event
        document.getElementById('cancelEventBtn').addEventListener('click', async () => {
            if (!currentEventData) return;
            
            const reason = prompt('Why are you cancelling this event? (This will be posted to the activity feed)');
            if (reason === null) return; // User clicked Cancel
            
            try {
                const response = await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'cancelEvent',
                        userId: currentUser.userId,
                        eventId: currentEventData.eventId,
                        reason: reason.trim()
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('Event cancelled', 'success');
                    showEventManager();
                } else {
                    showToast(result.message || 'Cancel failed', 'error');
                }
            } catch (error) {
                showToast('Cancel error', 'error');
            }
        });

        // Supplies management
        let currentSupplies = [];
        
        function loadSupplies(eventId) {
            const list = document.getElementById('suppliesList');
            
            // Get supplies from currentEventData
            currentSupplies = currentEventData.supplies || [];
            renderSupplies();
        }
        
        function renderSupplies() {
            const list = document.getElementById('suppliesList');
            
            if (currentSupplies.length === 0) {
                list.innerHTML = '<div style="font-size: 13px; color: #6b7280; padding: 10px 0;">No supplies listed yet.</div>';
                return;
            }
            
            let html = '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
            html += '<tr style="background: #f3f4f6; text-align: left;"><th style="padding: 8px;">Item</th><th style="padding: 8px;">Qty/$</th><th style="padding: 8px; text-align: center;">Got?</th><th></th></tr>';
            
            currentSupplies.forEach((supply, idx) => {
                const checkmark = supply.acquired ? '‚úÖ' : '‚¨ú';
                html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 8px;">${supply.item}${supply.description ? '<br><span style="font-size: 11px; color: #6b7280;">' + supply.description + '</span>' : ''}</td>
                    <td style="padding: 8px;">${supply.quantity || '-'}</td>
                    <td style="padding: 8px; text-align: center; cursor: pointer;" onclick="toggleSupplyAcquired(${idx})">${checkmark}</td>
                    <td style="padding: 4px;"><button onclick="removeSupply(${idx})" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 14px;">‚úï</button></td>
                </tr>`;
            });
            
            html += '</table>';
            list.innerHTML = html;
        }
        
        async function saveSupplies() {
            if (!currentEventData) return;
            
            try {
                await fetch(CONFIG.appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateEventSupplies',
                        userId: currentUser.userId,
                        eventId: currentEventData.eventId,
                        supplies: currentSupplies
                    })
                });
            } catch (e) {
                console.error('Save supplies error:', e);
            }
        }
        
        function toggleSupplyAcquired(idx) {
            currentSupplies[idx].acquired = !currentSupplies[idx].acquired;
            renderSupplies();
            saveSupplies();
        }
        
        function removeSupply(idx) {
            currentSupplies.splice(idx, 1);
            renderSupplies();
            saveSupplies();
        }

        document.getElementById('addSupplyBtn').addEventListener('click', () => {
            const item = prompt('Supply item name:');
            if (!item || !item.trim()) return;
            
            const description = prompt('Description (optional):') || '';
            const quantity = prompt('Quantity or $ needed:') || '';
            
            currentSupplies.push({
                item: item.trim(),
                description: description.trim(),
                quantity: quantity.trim(),
                acquired: false
            });
            
            renderSupplies();
            saveSupplies();
            showToast('Supply added', 'success');
        });

        // Upcoming Events
        function showUpcomingEvents() {
            hideAllScreens();
            document.getElementById('upcomingEventsScreen').classList.remove('hidden');
            loadUpcomingEvents();
        }

        async function loadUpcomingEvents() {
            const list = document.getElementById('upcomingEventsList');
            list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px;">Loading...</div>';

            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_upcoming_events');
                const result = await response.json();

                if (result.status !== 'success') {
                    list.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 30px;">Failed to load events</div>';
                    return;
                }

                const events = result.events || [];
                
                // Also update the banner
                updateUpcomingBanner(events);

                if (events.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px;">No upcoming events scheduled.</div>';
                    return;
                }

                let html = '';
                events.forEach(event => {
                    const dateStr = event.eventDate ? new Date(event.eventDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'TBD';
                    const timeStr = event.startTime ? formatTime12Hour(event.startTime) : '';

                    html += `<div style="background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border-radius: 12px; padding: 14px; margin-bottom: 10px; border: 1px solid #bbf7d0;">
                        <div style="font-weight: 600; color: #166534;">${event.title}</div>
                        <div style="font-size: 13px; color: #15803d; margin-top: 6px;">
                            üìÖ ${dateStr} ${timeStr ? '‚Ä¢ üïê ' + timeStr : ''} ‚Ä¢ üìç ${event.locationName}
                        </div>
                        ${event.description ? `<div style="font-size: 12px; color: #166534; margin-top: 8px;">${event.description}</div>` : ''}
                        <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">Organized by ${event.organization || event.coordinatorName || 'Unknown'}</div>
                    </div>`;
                });

                list.innerHTML = html;

            } catch (error) {
                console.error('Load upcoming events error:', error);
                list.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 30px;">Error loading events</div>';
            }
        }

        function updateUpcomingBanner(events) {
            const banner = document.getElementById('upcomingBannerText');
            if (events && events.length > 0) {
                const next = events[0];
                const dateStr = next.eventDate ? new Date(next.eventDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                banner.innerHTML = `<strong>${next.title}</strong> ‚Äî ${dateStr} ‚Ä¢ Tap for details`;
            } else {
                banner.textContent = 'No upcoming events ‚Ä¢ Tap to view';
            }
        }

        function formatTime12Hour(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const suffix = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${suffix}`;
        }

        // Load upcoming events on main screen
        async function loadUpcomingBanner() {
            try {
                const response = await fetch(CONFIG.appsScriptUrl + '?action=get_upcoming_events');
                const result = await response.json();
                if (result.status === 'success') {
                    updateUpcomingBanner(result.events || []);
                }
            } catch (e) {
                console.error('Banner load error:', e);
            }
        }
    </script>
</body>
</html>
